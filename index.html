<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoQuiz Ultimate Pro</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }, 
                    colors: { brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' } } 
                } 
            } 
        }
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ —Å—Ç–∏–ª–æ–≤–µ –∑–∞ –°–û–ü —Ä–µ–∂–∏–º */
        .sop-text { font-size: 2.5rem !important; line-height: 1.3 !important; font-weight: 900; letter-spacing: 0.05em; }
        .sop-btn { font-size: 2rem !important; padding: 2.5rem !important; font-weight: 800 !important; border-width: 4px !important; }
        .sop-container { max-width: 90% !important; }

        input[type=range] { accent-color: #4f46e5; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-100">

    <div id="app" class="h-full flex flex-col relative">
        <!-- Loader -->
        <div id="auth-loader" class="fixed inset-0 bg-white z-[10000] flex items-center justify-center flex-col gap-6 transition-opacity duration-500">
            <div class="w-16 h-16 border-4 border-brand-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-black text-brand-900 tracking-widest animate-pulse">–ó–ê–†–ï–ñ–î–ê–ù–ï...</p>
        </div>

        <div id="msg-container" class="fixed top-6 right-6 z-[10001] flex flex-col items-end pointer-events-none gap-2"></div>

        <!-- 1. –ù–ò–í–û: –í–•–û–î -->
        <div id="screen-welcome" class="flex h-full w-full bg-slate-50 relative z-10 overflow-hidden flex-col md:flex-row">
            <div class="flex-1 relative flex flex-col justify-center items-center p-6 md:p-12 bg-white text-center">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-600 to-emerald-500"></div>
                <div class="w-full max-w-md space-y-8 animate-pop">
                    <div>
                        <h1 class="text-6xl font-black text-slate-900 tracking-tighter">VideoQuiz</h1>
                        <p class="text-slate-400 font-bold mt-2">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ –æ–±—É—á–µ–Ω–∏–µ</p>
                    </div>

                    <div class="flex p-1.5 bg-slate-100 rounded-3xl shadow-inner">
                        <button onclick="window.switchTab('solo')" id="tab-solo" class="flex-1 py-3.5 rounded-2xl font-black text-sm bg-white shadow-sm text-brand-600 transition-all uppercase tracking-widest">–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–æ</button>
                        <button onclick="window.switchTab('class')" id="tab-class" class="flex-1 py-3.5 rounded-2xl font-black text-sm text-slate-400 transition-all uppercase tracking-widest">–í –ö–ª–∞—Å</button>
                    </div>

                    <!-- –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–ï–ù –†–ï–ñ–ò–ú (–°–û–ü / –î–û–ú–ê–®–ù–û / –û–ë–°–™–ñ–î–ê–ù–ï) -->
                    <div id="panel-solo" class="space-y-4">
                        <div class="bg-slate-50 p-8 rounded-[2.5rem] border border-slate-200 shadow-xl">
                             <input type="text" id="ind-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="w-full p-4 bg-white rounded-2xl border-2 border-slate-100 font-bold mb-4 outline-none focus:border-brand-500 transition-all">
                             <input type="text" id="ind-quiz-code" placeholder="–ü–æ—Å—Ç–∞–≤–∏ –¥—ä–ª–≥–∏—è –∫–æ–¥ –Ω–∞ —É—Ä–æ–∫–∞ —Ç—É–∫..." class="w-full p-4 bg-white rounded-2xl border-2 border-slate-100 font-mono text-xs mb-6 outline-none focus:border-brand-500 text-center">
                             
                             <div class="grid grid-cols-2 gap-3 mb-6">
                                <label class="flex flex-col items-center justify-center gap-2 p-3 bg-white rounded-2xl border-2 border-slate-100 cursor-pointer text-xs font-black hover:bg-brand-50 transition-colors select-none">
                                    <input type="checkbox" id="ind-sop-mode" class="w-5 h-5 accent-brand-600"> 
                                    <span class="text-brand-600">–°–û–ü –†–ï–ñ–ò–ú üîä</span>
                                </label>
                                <label class="flex flex-col items-center justify-center gap-2 p-3 bg-white rounded-2xl border-2 border-slate-100 cursor-pointer text-xs font-black hover:bg-amber-50 transition-colors select-none">
                                    <input type="checkbox" id="ind-discussion-mode" class="w-5 h-5 accent-amber-500"> 
                                    <span class="text-amber-600">–û–ë–°–™–ñ–î–ê–ù–ï</span>
                                </label>
                             </div>
                             
                             <button onclick="window.startIndividual()" class="w-full py-5 bg-brand-600 hover:bg-brand-700 text-white rounded-[2rem] font-black shadow-xl transform active:scale-95 transition-all text-lg uppercase tracking-widest">–°–¢–ê–†–¢</button>
                             <p class="text-[10px] text-slate-400 mt-4 font-bold max-w-xs mx-auto">
                                * –î–æ–º–∞—à–Ω–æ: –ó–∞–ø–∏—Å–≤–∞ —Å–µ –≤ –æ–±–ª–∞–∫–∞.<br>
                                * –û–±—Å—ä–∂–¥–∞–Ω–µ: –ù–ï —Å–µ –∑–∞–ø–∏—Å–≤–∞.
                             </p>
                        </div>
                    </div>

                    <div id="panel-class" class="hidden space-y-4">
                        <div class="bg-emerald-50 p-8 rounded-[2.5rem] border border-emerald-100 shadow-xl">
                            <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="w-full p-4 bg-white rounded-2xl border-2 border-emerald-100 font-bold mb-4 outline-none">
                            <input type="number" id="live-pin" placeholder="PIN –ö–û–î" class="w-full p-4 bg-white rounded-2xl border-2 border-emerald-100 font-black text-5xl text-center tracking-[0.4em] outline-none mb-6 uppercase">
                            <button onclick="window.joinLiveSession()" class="w-full py-5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-[2rem] font-black shadow-xl transform active:scale-95 transition-all uppercase text-lg tracking-widest">–í–ª–µ–∑</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –£—á–∏—Ç–µ–ª—Å–∫–∏ –í—Ö–æ–¥ -->
            <div class="w-full md:w-[480px] bg-slate-900 text-white p-12 flex flex-col justify-center relative">
                <div class="relative z-10 space-y-8 animate-pop">
                    <div>
                        <h2 id="auth-title" class="text-4xl font-black mb-2 tracking-tight">–£—á–∏—Ç–µ–ª</h2>
                        <p id="auth-desc" class="text-slate-400 font-medium">–û–±–ª–∞—á–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—Ä–æ—Ü–∏.</p>
                    </div>
                    <form onsubmit="event.preventDefault(); window.handleAuthSubmit();" class="space-y-4">
                        <input type="email" id="auth-email" placeholder="–ò–º–µ–π–ª" class="w-full p-5 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-brand-500 font-bold transition-all" autocomplete="username">
                        <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-5 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-brand-500 font-bold transition-all" autocomplete="current-password">
                        <div id="reg-extra" class="hidden animate-fade-in">
                            <input type="password" id="auth-teacher-code" placeholder="–ö–æ–¥: vilidaf76" class="w-full p-5 bg-amber-500/10 border border-amber-500/30 rounded-2xl text-amber-200 outline-none mt-2 font-bold text-center tracking-widest uppercase">
                        </div>
                        <button type="submit" id="auth-btn" class="w-full py-5 bg-brand-600 hover:bg-brand-500 text-white rounded-[2rem] font-black uppercase tracking-widest shadow-2xl transition-all active:scale-95 border-b-4 border-brand-800">–í–ª–µ–∑</button>
                    </form>
                    <button onclick="window.toggleAuthMode()" id="auth-toggle" class="text-sm text-slate-500 hover:text-white font-bold transition-all w-full text-center underline decoration-brand-500">–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
            </div>
        </div>

        <!-- 2. –ù–ò–í–û: –£–ß–ò–¢–ï–õ–°–ö–ò –î–ê–®–ë–û–†–î -->
        <div id="screen-dashboard" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-20">
            <header class="bg-white border-b px-8 py-5 flex justify-between items-center shadow-sm shrink-0">
                <div class="flex items-center gap-5">
                    <div class="w-14 h-14 bg-brand-600 rounded-[1.2rem] flex items-center justify-center text-white shadow-xl"><i data-lucide="library" class="w-7 h-7"></i></div>
                    <div><h1 class="text-2xl font-black tracking-tighter uppercase">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1><p id="user-display" class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-0.5">...</p></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.initCreateMode()" class="px-8 py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl font-black text-xs shadow-lg flex items-center gap-3 transition-all"><i data-lucide="plus" class="w-5 h-5"></i> –ù–û–í –£–†–û–ö</button>
                    <button onclick="window.handleLogout()" class="p-4 bg-slate-100 text-slate-400 hover:text-rose-500 rounded-2xl transition-all"><i data-lucide="log-out"></i></button>
                </div>
            </header>
            
            <main class="flex-1 overflow-y-auto p-10 max-w-7xl mx-auto w-full space-y-12 pb-32 scrollbar-hide">
                <section>
                    <h2 class="text-xl font-black text-slate-800 flex items-center gap-3 mb-8 uppercase tracking-widest"><i data-lucide="film" class="text-brand-500"></i> –ú–æ–∏—Ç–µ –£—Ä–æ—Ü–∏</h2>
                    <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                </section>

                <section class="bg-white rounded-[3rem] border border-slate-200 shadow-xl overflow-hidden">
                    <div class="p-10 border-b border-slate-100 bg-slate-50/50 flex flex-col md:flex-row justify-between items-center gap-6">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tighter uppercase">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div class="flex bg-white p-2 rounded-2xl border border-slate-200 shadow-inner">
                             <button onclick="window.switchHistoryTab('solo')" id="h-tab-solo" class="px-8 py-3 rounded-xl font-black text-xs bg-brand-600 text-white shadow-xl transition-all uppercase">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏</button>
                             <button onclick="window.switchHistoryTab('class')" id="h-tab-class" class="px-8 py-3 rounded-xl font-black text-xs text-slate-400 hover:text-brand-600 transition-all uppercase">–í –ö–ª–∞—Å</button>
                        </div>
                    </div>
                    <div id="history-content" class="overflow-x-auto scrollbar-hide">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-400 font-black text-[10px] uppercase tracking-[0.2em] border-b border-slate-100">
                                <tr id="history-head"></tr>
                            </thead>
                            <tbody id="history-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <!-- 3. –ù–ò–í–û: –†–ï–î–ê–ö–¢–û–† -->
        <div id="screen-editor" class="hidden h-full flex flex-col bg-slate-900 absolute inset-0 z-30 overflow-hidden text-slate-800">
            <header class="bg-white border-b px-8 py-5 flex justify-between items-center relative z-50 shadow-xl shrink-0">
                <div class="flex items-center gap-5">
                    <button onclick="window.switchScreen('dashboard')" class="p-3 hover:bg-slate-100 rounded-2xl transition-all text-slate-600"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                    <h2 class="font-black text-xl tracking-tighter uppercase">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h2>
                </div>
                <button onclick="window.finalizeAndSaveQuiz()" class="px-10 py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-[2rem] font-black text-sm shadow-2xl flex items-center gap-3 transition-all"><i data-lucide="cloud-upload" class="w-5 h-5"></i> –ó–ê–ü–ê–ó–ò</button>
            </header>
            
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">
                <div class="flex-1 bg-black relative flex flex-col justify-center overflow-hidden">
                    <div id="editor-video-container" class="w-full h-full relative z-10 pointer-events-auto"></div>
                    <div id="editor-video-prompt" class="absolute inset-0 z-50 bg-slate-950 flex items-center justify-center p-8 backdrop-blur-sm">
                        <div class="max-w-lg w-full space-y-8 text-center animate-pop">
                            <h3 class="text-4xl font-black text-white tracking-tighter">YouTube –í–∏–¥–µ–æ</h3>
                            <input type="text" id="editor-yt-url" placeholder="–õ–∏–Ω–∫ –æ—Ç YouTube..." class="w-full p-6 bg-white border-4 border-transparent focus:border-brand-500 rounded-3xl font-bold text-slate-800 text-center transition-all">
                            <button onclick="window.loadEditorVideo()" class="w-full py-5 bg-brand-600 hover:bg-brand-500 text-white rounded-[2.5rem] font-black text-xl shadow-2xl uppercase tracking-widest">–ó–∞—Ä–µ–¥–∏</button>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-[450px] bg-white border-l border-slate-200 flex flex-col z-30 shadow-2xl shrink-0">
                    <div class="p-8 border-b bg-slate-50 flex justify-between items-center shrink-0">
                        <div class="flex flex-col">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">–°–ï–ö–£–ù–î–ê</span>
                            <span id="editor-timer" class="font-mono font-black text-brand-600 text-4xl tracking-tighter">00:00</span>
                        </div>
                        <button onclick="window.openQuestionModal()" class="w-16 h-16 bg-brand-600 hover:bg-brand-700 text-white rounded-[1.5rem] flex items-center justify-center shadow-xl border-b-4 border-brand-800"><i data-lucide="plus" class="w-8 h-8"></i></button>
                    </div>
                    <div id="editor-q-list" class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50/50 scrollbar-hide pb-32"></div>
                </div>
            </div>
        </div>

        <!-- 4. –ù–ò–í–û: –°–ï–°–ò–Ø –ù–ê –ñ–ò–í–û (HOST) -->
        <div id="screen-live-host" class="hidden h-full flex flex-col bg-slate-950 absolute inset-0 z-[60] overflow-hidden">
            <div class="bg-slate-900/80 backdrop-blur-2xl border-b border-white/10 px-10 py-4 flex justify-between items-center h-28 relative z-20 shrink-0">
                <div class="flex items-center gap-8">
                    <div class="bg-brand-600 px-8 py-3 rounded-3xl shadow-2xl border border-brand-400/30">
                        <span class="text-[9px] uppercase font-black text-brand-200 block tracking-widest mb-1 text-center opacity-60">PIN</span>
                        <h1 id="host-pin-display" class="text-4xl font-black text-white leading-none tracking-tight">....</h1>
                    </div>
                    <div class="text-white">
                        <div id="host-count" class="text-3xl font-black tracking-tighter leading-none">0</div>
                        <div class="flex items-center gap-2 text-[10px] font-black text-slate-500 uppercase tracking-widest mt-1">–£—á–µ–Ω–∏—Ü–∏</div>
                    </div>
                </div>
                <div class="flex-1 max-w-xl mx-16">
                    <div class="h-3 bg-white/5 rounded-full overflow-hidden shadow-inner ring-1 ring-white/5"><div id="host-progress-bar" class="h-full bg-emerald-500 transition-all duration-1000 shadow-[0_0_20px_rgba(16,185,129,0.4)]" style="width: 0%"></div></div>
                    <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase mt-3 tracking-[0.2em]"><span>–ü—Ä–æ–≥—Ä–µ—Å</span><span id="host-progress-text">0%</span></div>
                </div>
                <div class="flex gap-4">
                    <button onclick="window.finishSession()" class="px-10 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-[1.5rem] font-black text-xs shadow-2xl uppercase tracking-widest border-b-4 border-emerald-800">–ö—Ä–∞–π</button>
                    <button onclick="window.quitHostSession()" class="p-4 bg-slate-800 text-slate-400 hover:text-white rounded-2xl transition-all border border-white/5"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden p-8 gap-8 pb-10">
                <div class="flex-1 bg-black rounded-[3rem] overflow-hidden relative border-[8px] border-white/5 shadow-2xl">
                    <div id="host-player-container" class="w-full h-full pointer-events-auto aspect-video mx-auto"></div>
                    <div id="host-start-overlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center p-8 z-30 animate-pop">
                        <div id="host-qr-container" class="p-10 bg-white rounded-[3.5rem] shadow-2xl mb-12 transform -rotate-2"></div>
                        <button onclick="window.startLiveVideo()" class="px-20 py-10 bg-brand-600 hover:bg-brand-500 text-white rounded-[3.5rem] font-black text-5xl shadow-[0_30px_70px_rgba(79,70,229,0.4)] transition-all flex items-center gap-8 border-b-[12px] border-brand-800 uppercase tracking-tighter"><i data-lucide="play" class="w-16 h-16 fill-current"></i> –ü–£–°–ù–ò</button>
                    </div>
                    <div id="host-resume-overlay" class="hidden absolute inset-0 bg-slate-950/90 backdrop-blur-xl flex flex-col items-center justify-center p-8 z-40 animate-fade-in text-center">
                        <h3 class="text-white text-6xl font-black mb-12 uppercase tracking-tighter">–í—Ä–µ–º–µ –∑–∞ –≤—ä–ø—Ä–æ—Å!</h3>
                        <button onclick="window.resumeLiveVideo()" class="px-20 py-10 bg-emerald-500 hover:bg-emerald-400 text-white rounded-[3.5rem] font-black text-4xl shadow-2xl transform active:scale-95 border-b-[12px] border-emerald-800 uppercase"><i data-lucide="play-circle" class="w-16 h-16"></i> –ü–†–û–î–™–õ–ñ–ò</button>
                    </div>
                </div>

                <div class="w-full lg:w-[400px] bg-white/5 backdrop-blur-3xl border border-white/10 rounded-[3rem] flex flex-col overflow-hidden shadow-2xl shrink-0 ring-1 ring-white/5">
                    <div class="p-8 border-b border-white/10 bg-white/5 flex items-center justify-between font-black text-white tracking-[0.3em] text-[11px] uppercase"><i data-lucide="trophy" class="text-amber-400 w-5 h-5"></i> –ö–ª–∞—Å–∏—Ä–∞–Ω–µ</div>
                    <div class="flex-1 overflow-y-auto p-6 scrollbar-hide space-y-3" id="host-leaderboard"></div>
                </div>
            </div>
        </div>

        <!-- 5. –£–ß–ï–ù–ò–ö -->
        <div id="screen-live-client" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-[70] overflow-hidden">
            <div id="client-waiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-12 animate-pop">
                <div class="w-48 h-48 bg-white rounded-full flex items-center justify-center text-[10rem] shadow-2xl border-[16px] border-brand-100 animate-bounce" id="client-avatar">üòé</div>
                <div class="space-y-4">
                    <h2 class="text-5xl font-black text-slate-900 tracking-tighter">–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å–∞!</h2>
                    <p class="text-slate-400 font-black text-xl uppercase tracking-[0.3em]">–ì–ª–µ–¥–∞–π –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è</p>
                </div>
            </div>

            <div id="client-question" class="hidden flex-1 flex flex-col p-6 overflow-y-auto animate-fade-in bg-brand-600 text-white">
                <div class="bg-white p-10 rounded-[3rem] shadow-2xl border-b-[12px] border-slate-200 mb-10 text-center ring-4 ring-white/20">
                    <h2 id="client-q-text" class="text-3xl font-black text-slate-800 leading-tight tracking-tight uppercase">...</h2>
                </div>
                <div id="client-options" class="grid gap-4 max-w-lg mx-auto w-full mb-32 pb-24"></div>
                <button id="client-confirm-btn" onclick="window.submitLiveAnswer()" class="hidden fixed bottom-10 left-10 right-10 py-8 bg-white text-brand-600 hover:bg-slate-50 rounded-[3rem] font-black text-3xl shadow-2xl uppercase tracking-widest z-[100] border-b-8 border-slate-200 transform active:scale-95 transition-all">–ü–û–¢–í–™–†–î–ò</button>
            </div>

            <div id="client-finished" class="hidden flex-1 flex flex-col items-center justify-center p-8 bg-brand-600 text-white absolute inset-0 z-[80]">
                <h1 class="text-7xl font-black mb-6 uppercase tracking-tighter animate-pop">–†–µ–∑—É–ª—Ç–∞—Ç</h1>
                <div class="bg-white text-brand-600 w-64 h-64 rounded-full flex flex-col items-center justify-center shadow-2xl border-[20px] border-brand-400/50 mb-16 animate-pop">
                    <span id="client-final-score" class="text-9xl font-black leading-none tracking-tighter">0</span>
                    <span class="text-lg font-black uppercase tracking-widest opacity-40 mt-4">—Ç–æ—á–∫–∏</span>
                </div>
                <button onclick="location.reload()" class="px-20 py-8 bg-brand-900 hover:bg-black text-white rounded-[3rem] font-black text-2xl shadow-2xl transition-all uppercase tracking-widest border-b-4 border-black">–û–¢–ù–ê–ß–ê–õ–û</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–ò -->
        <div id="modal-q" class="hidden fixed inset-0 bg-black/90 z-[200] items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-[3.5rem] shadow-2xl w-full max-w-3xl max-h-[95vh] flex flex-col overflow-hidden animate-pop border-8 border-white/20">
                <div class="p-10 border-b bg-slate-50 flex justify-between items-center shrink-0 font-black text-3xl uppercase tracking-tight">–í—ä–ø—Ä–æ—Å –≤ —É—Ä–æ–∫–∞ <button onclick="window.closeQuestionModal()" class="w-14 h-14 flex items-center justify-center rounded-[1.2rem] bg-slate-200 text-slate-500 hover:bg-rose-500 hover:text-white transition-all"><i data-lucide="x" class="w-8 h-8"></i></button></div>
                <div class="p-10 overflow-y-auto space-y-10 flex-1 scrollbar-hide">
                     <textarea id="m-q-text" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≤—ä–ø—Ä–æ—Å–∞ —Ç—É–∫..." class="w-full p-8 bg-slate-50 border-4 border-slate-100 rounded-[2.5rem] font-black text-slate-800 focus:border-brand-500 outline-none h-40 resize-none text-2xl"></textarea>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8 uppercase font-black text-slate-400 text-[10px] tracking-widest">
                        <div>–¢–∏–ø <select id="m-q-type" onchange="window.updateModalFields()" class="w-full p-6 bg-slate-50 border-4 border-slate-100 rounded-[1.8rem] font-black text-slate-800 text-lg outline-none mt-2 appearance-none"><option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option><option value="multiple">–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–µ—Ä–Ω–∏</option><option value="boolean">–í—è—Ä–Ω–æ/–ì—Ä–µ—à–Ω–æ</option><option value="ordering">–ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ</option><option value="numeric">–ü–ª—ä–∑–≥–∞—á</option><option value="timeline">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è</option></select></div>
                        <div>–í—Ä–µ–º–µ (—Å–µ–∫) <div class="flex gap-2 mt-2"><button onclick="document.getElementById('m_q_time').value = Math.max(0, parseInt(document.getElementById('m_q_time').value)-1)" class="p-6 bg-slate-200 rounded-2xl font-black text-slate-700">-1</button><input type="number" id="m_q_time" value="0" class="flex-1 p-6 bg-slate-50 border-4 border-slate-100 rounded-[1.8rem] font-black text-2xl text-center outline-none text-slate-800"><button onclick="document.getElementById('m_q_time').value = parseInt(document.getElementById('m_q_time').value)+1" class="p-6 bg-slate-200 rounded-2xl font-black text-slate-700">+1</button></div></div>
                        <div class="md:col-span-2">–¢–æ—á–∫–∏ –∑–∞ –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä <input type="number" id="m-q-points" value="1" class="w-full p-4 border-2 rounded-xl mt-2 font-black text-slate-800"></div>
                     </div>
                     <div id="m-q-opts-area" class="space-y-5"></div>
                </div>
                <button onclick="window.saveCurrentQuestion()" class="m-10 py-6 bg-brand-600 hover:bg-brand-700 text-white rounded-[2.5rem] font-black text-xl shadow-2xl uppercase tracking-[0.2em] border-b-[10px] border-brand-800 transform active:scale-95 transition-all">–ó–∞–ø–∞–∑–∏ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ –°–ü–û–î–ï–õ–Ø–ù–ï -->
        <div id="modal-share" class="hidden fixed inset-0 bg-black/90 z-[200] items-center justify-center p-4 backdrop-blur-md">
             <div class="bg-white rounded-[3rem] shadow-2xl p-10 max-w-lg w-full text-center animate-pop border-8 border-white/20">
                 <h3 class="text-4xl font-black text-slate-900 mb-6 uppercase tracking-tight">–°–ø–æ–¥–µ–ª–∏ –£—Ä–æ–∫–∞</h3>
                 <p class="text-slate-500 font-bold mb-8">–ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ —Ç–æ–∑–∏ –∫–æ–¥ –∑–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª–Ω–∞ —Ä–∞–±–æ—Ç–∞.</p>
                 <textarea id="share-code-area" class="w-full p-6 bg-slate-100 rounded-3xl font-mono text-xs break-all border-4 border-slate-200 h-32 mb-8 focus:border-brand-500 outline-none" readonly></textarea>
                 <div class="flex gap-4">
                     <button onclick="window.doCopyCode()" class="flex-1 py-5 bg-brand-600 text-white rounded-[2rem] font-black text-xl shadow-xl hover:bg-brand-500 transition-all uppercase">–ö–û–ü–ò–†–ê–ô</button>
                     <button onclick="document.getElementById('modal-share').classList.add('hidden')" class="p-5 bg-slate-200 text-slate-500 rounded-[2rem] hover:bg-slate-300 font-black"><i data-lucide="x" class="w-6 h-6"></i></button>
                 </div>
             </div>
        </div>

        <!-- –ò–ù–î–ò–í–ò–î–£–ê–õ–ï–ù OVERLAY (SOLO / SOP) -->
        <div id="ind-overlay" class="absolute inset-0 bg-slate-900/98 z-[9999] hidden flex-col items-center justify-center p-10 animate-fade-in overflow-y-auto">
            <div class="w-full max-w-4xl space-y-12 text-center relative animate-pop">
                 <button onclick="window.speakQ()" id="ind-speak-btn" class="hidden absolute -top-16 right-0 p-4 bg-brand-600 text-white rounded-full shadow-2xl transform hover:scale-110 active:scale-90 transition-all"><i data-lucide="volume-2" class="w-10 h-10"></i></button>
                 <h2 id="ind-overlay-q-text" class="font-black text-white leading-tight drop-shadow-2xl text-5xl tracking-tight uppercase">...</h2>
                 <div id="ind-overlay-options" class="grid gap-6 w-full"></div>
                 <button id="ind-confirm-btn" onclick="window.confirmSoloAnswer()" class="hidden w-full py-8 bg-emerald-600 text-white rounded-[3rem] font-black text-4xl shadow-2xl mt-8 border-b-[12px] border-emerald-800 active:border-b-0 uppercase tracking-widest transform active:scale-95">–ü–û–¢–í–™–†–î–ò</button>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
        <div id="modal-view-stat" class="hidden fixed inset-0 bg-black/80 z-[300] items-center justify-center p-4 backdrop-blur-md">
            <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden animate-pop">
                <div class="p-8 border-b bg-slate-50 flex justify-between items-center shrink-0">
                    <h3 class="font-black text-2xl text-slate-900 tracking-tight uppercase" id="stat-view-title">–ü—Ä–µ–≥–ª–µ–¥</h3>
                    <button onclick="document.getElementById('modal-view-stat').classList.add('hidden')" class="w-12 h-12 flex items-center justify-center rounded-2xl bg-slate-200 text-slate-500 hover:bg-rose-500 hover:text-white transition-all"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-0"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-400 font-black text-[10px] uppercase tracking-widest sticky top-0 uppercase"><tr><th class="p-6 pl-8">–£—á–µ–Ω–∏–∫</th><th class="p-6 text-right">–†–µ–∑—É–ª—Ç–∞—Ç</th></tr></thead><tbody id="stat-view-body" class="divide-y divide-slate-100 uppercase font-bold text-slate-700"></tbody></table></div>
            </div>
        </div>

        <!-- E–ö–†–ê–ù –§–ò–ù–ê–õ -->
        <div id="screen-finish" class="hidden h-full flex flex-col items-center justify-center bg-slate-50 p-8 text-center absolute inset-0 z-50">
             <div class="bg-white p-12 rounded-[4rem] shadow-2xl border-b-[16px] border-indigo-100 max-w-md w-full space-y-10 animate-pop transform hover:-rotate-1 transition-transform">
                <div class="w-32 h-32 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto text-6xl ring-8 ring-indigo-50 shadow-inner">üèÜ</div>
                <div><h2 class="text-4xl font-black text-slate-800 mb-4 tracking-tighter uppercase">–†–µ–∑—É–ª—Ç–∞—Ç</h2><div id="res-score" class="text-8xl font-black text-brand-600 tracking-tighter">0 / 0</div></div>
                <div id="solo-end-btn-container"><button onclick="window.location.reload()" class="w-full py-6 bg-slate-800 text-white rounded-[2rem] font-black uppercase tracking-widest hover:bg-slate-900 shadow-xl border-b-4 border-black">–û–¢–ù–ê–ß–ê–õ–û</button></div>
            </div>
        </div>

    </div>

    <!-- === –õ–û–ì–ò–ö–ê === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, addDoc, query, where, limit, getDocs, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'videoquiz-ultimate-live';
        let firebaseConfig;
        try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { firebaseConfig = { apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314", authDomain: "videoquiz-ultimate.firebaseapp.com", projectId: "videoquiz-ultimate", storageBucket: "videoquiz-ultimate.firebasestorage.app", messagingSenderId: "793138692820", appId: "1:793138692820:web:8ee2418d28d47fca6bf141" }; }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let user = null, myQuizzes = [], questions = [], currentQuiz = null, currentVideoId = "";
        let player = null, hostPlayer = null, solvePlayer = null;
        let sessionID = "", liveParticipants = [], activeHistoryTab = 'solo';
        let editingQuizId = null, editingQuestionIdx = -1, liveActiveQIdx = -1;
        let liveScore = 0, currentLiveQ = null, lastClientAnsweredIdx = -1;
        let authMode = 'login', sopEnabled = false, isDiscussion = false, currentStudentName = "";
        let unsubscribes = { myQuizzes: null, soloStats: null, classStats: null, session: null, participants: null };

        const EMOTICONS = ['üòé', 'ü§î', 'üöÄ', 'üî•', 'üéì', 'üìö', '‚ö°', 'ü§ñ', 'üéâ', 'üåü'];
        const FIXED_TEACHER_ID = "uNdGTBsgatZX4uOPTZqKG9qLJVZ2"; 

        // –§–£–ù–ö–¶–ò–ò –ó–ê –ü–™–¢–ò–©–ê
        const getPublicCollection = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getPublicDoc = (col, id) => doc(db, 'artifacts', appId, 'public', 'data', col, id);
        const getUserCollection = (userId, name) => collection(db, 'artifacts', appId, 'users', userId, name);
        const getUserDoc = (userId, col, id) => doc(db, 'artifacts', appId, 'users', userId, col, id);

        // --- GLOBAL UI FUNCTIONS ---
        window.switchScreen = (n) => {
            document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
            const s = document.getElementById('screen-' + n); if(s) s.classList.remove('hidden');
            if(n === 'dashboard') window.loadTeacherData();
            if(window.lucide) lucide.createIcons();
            window.scrollTo(0,0);
        };

        window.showMessage = (t, type = 'info') => {
            const c = document.getElementById('msg-container');
            const m = document.createElement('div');
            m.className = `p-5 rounded-[1.5rem] text-white shadow-2xl mb-3 animate-pop flex items-center gap-4 font-black border-b-[6px] ${type === 'error' ? 'bg-rose-500 border-rose-700' : 'bg-brand-600 border-brand-800'}`;
            m.innerHTML = `<i data-lucide="${type === 'error' ? 'alert-triangle' : 'check-circle'}"></i> ${t}`;
            c.appendChild(m); lucide.createIcons(); setTimeout(() => m.remove(), 4000);
        };

        window.switchTab = (t) => {
            document.getElementById('panel-solo').classList.toggle('hidden', t !== 'solo');
            document.getElementById('panel-class').classList.toggle('hidden', t !== 'class');
            document.getElementById('tab-solo').className = t === 'solo' ? 'flex-1 py-4 rounded-2xl font-black text-sm bg-white shadow-lg text-brand-600' : 'flex-1 py-4 rounded-2xl font-black text-sm text-slate-400';
            document.getElementById('tab-class').className = t === 'class' ? 'flex-1 py-4 rounded-2xl font-black text-sm bg-white shadow-lg text-emerald-600' : 'flex-1 py-4 rounded-2xl font-black text-sm text-slate-400';
        };

        // --- AUTH ---
        const initAuth = async () => {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 try { await signInWithCustomToken(auth, __initial_auth_token); } 
                 catch(e) { await signInAnonymously(auth); }
             } else if (!auth.currentUser) { }
        };
        initAuth();

        onAuthStateChanged(auth, async u => {
            user = u;
            if(u) {
                if(!window.location.search.includes('pin=')) {
                    if (u.email || u.isAnonymous) window.switchScreen('dashboard');
                }
            } else { window.switchScreen('welcome'); }
            const loader = document.getElementById('auth-loader');
            if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.classList.add('hidden'), 500); }
        });

        window.toggleAuthMode = () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').innerText = authMode === 'login' ? '–£—á–∏—Ç–µ–ª—Å–∫–∏ –í—Ö–æ–¥' : '–ù–æ–≤–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            document.getElementById('auth-btn').innerText = authMode === 'login' ? '–í–ª–µ–∑' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            document.getElementById('reg-extra').classList.toggle('hidden', authMode === 'login');
            document.getElementById('auth-toggle').innerHTML = authMode === 'login' ? '–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400 underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>' : '–ò–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400 underline">–í–ª–µ–∑</span>';
        };

        window.handleAuthSubmit = async () => {
            const em = document.getElementById('auth-email').value.trim();
            const ps = document.getElementById('auth-password').value.trim();
            if(!em || !ps) return window.showMessage("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –¥–∞–Ω–Ω–∏—Ç–µ", "error");
            window.showMessage("–û–±—Ä–∞–±–æ—Ç–∫–∞...", "info");
            try {
                if(authMode === 'register') {
                    if(document.getElementById('auth-teacher-code').value !== 'vilidaf76') return window.showMessage("–ì—Ä–µ—à–µ–Ω –∫–æ–¥!", "error");
                    try { await createUserWithEmailAndPassword(auth, em, ps); } 
                    catch(re) { if (re.code === 'auth/operation-not-allowed') await signInAnonymously(auth); else throw re; }
                    await setDoc(getUserDoc(auth.currentUser.uid, 'settings', 'profile'), { email: em, role: 'teacher', createdAt: serverTimestamp() });
                    window.showMessage("–£—Å–ø–µ—à–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!", "success");
                } else {
                    try { await signInWithEmailAndPassword(auth, em, ps); } 
                    catch(le) { if (le.code === 'auth/operation-not-allowed') await signInAnonymously(auth); else throw le; }
                    window.showMessage("–£—Å–ø–µ—à–µ–Ω –≤—Ö–æ–¥!", "success");
                }
            } catch(e) { window.showMessage("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥.", "error"); }
        };

        window.handleLogout = () => {
            Object.values(unsubscribes).forEach(u => u && u());
            unsubscribes = { myQuizzes: null, soloStats: null, classStats: null, session: null, participants: null };
            signOut(auth);
        };

        // --- TEACHER PANEL ---
        window.loadTeacherData = async () => {
            if(!user) return;
            const targetId = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            document.getElementById('user-display').innerText = user.email || 'Teacher Panel';
            if(unsubscribes.myQuizzes) unsubscribes.myQuizzes();
            try {
                unsubscribes.myQuizzes = onSnapshot(getUserCollection(targetId, 'my_quizzes'), s => {
                    myQuizzes = s.docs.map(d => ({ ...d.data(), id: d.id }));
                    window.renderMyQuizzes();
                });
            } catch (e) { }
            window.switchHistoryTab(activeHistoryTab);
        };

        window.renderMyQuizzes = () => {
            const list = document.getElementById('my-quizzes-list');
            if(myQuizzes.length === 0) { list.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 font-bold bg-white rounded-[2rem] border-4 border-dashed border-slate-100 uppercase tracking-widest text-[10px]">–ù—è–º–∞—Ç–µ –¥–æ–±–∞–≤–µ–Ω–∏ —É—Ä–æ—Ü–∏.</div>`; return; }
            list.innerHTML = myQuizzes.map(q => {
                const code = btoa(unescape(encodeURIComponent(JSON.stringify({v:q.v, q:q.questions, title:q.title, owner: user.isAnonymous ? FIXED_TEACHER_ID : user.uid}))));
                return `
                <div class="bg-white p-8 rounded-[3rem] border border-slate-200 shadow-sm hover:shadow-2xl transition-all group flex flex-col justify-between transform hover:-translate-y-2">
                    <div class="mb-6">
                        <span class="bg-brand-50 text-brand-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-[0.2em]">${q.questions?.length||0} –≤—ä–ø—Ä–æ—Å–∞</span>
                        <h4 class="font-black text-2xl text-slate-800 line-clamp-2 mt-4 leading-tight uppercase tracking-tight">${q.title}</h4>
                    </div>
                    <div class="flex gap-2.5 pt-8 border-t border-slate-100">
                        <button onclick="window.startLiveSessionHost('${q.id}')" title="–°—Ç–∞—Ä—Ç –Ω–∞ –∂–∏–≤–æ" class="flex-1 py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl font-black text-[10px] flex items-center justify-center gap-2 shadow-xl border-b-4 border-brand-900 active:translate-y-1 active:border-b-0 uppercase"><i data-lucide="play" class="w-4 h-4 fill-current"></i> –°–¢–ê–†–¢</button>
                        <button onclick="window.showShareModal('${code}')" title="–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¥—ä–ª—ä–≥ –∫–æ–¥" class="p-4 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-2xl transition-all"><i data-lucide="share-2" class="w-5 h-5 text-amber-600"></i></button>
                        <button onclick="window.initEditMode('${q.id}')" title="–†–µ–¥–∞–∫—Ü–∏—è" class="p-4 bg-slate-50 text-slate-500 hover:bg-slate-200 rounded-2xl transition-all"><i data-lucide="pencil" class="w-5 h-5 text-slate-500"></i></button>
                        <button onclick="window.deleteQuiz('${q.id}')" title="–ò–∑—Ç—Ä–∏–π" class="p-4 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-2xl transition-all"><i data-lucide="trash-2" class="w-5 h-5 text-rose-500"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };

        window.showShareModal = (code) => {
            document.getElementById('share-code-area').value = code;
            document.getElementById('modal-share').classList.remove('hidden');
            document.getElementById('modal-share').classList.add('flex');
        };

        window.doCopyCode = () => {
            const el = document.getElementById('share-code-area'); el.select(); document.execCommand('copy');
            window.showMessage("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω!");
        };

        window.deleteQuiz = async (id) => { if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) await deleteDoc(getUserDoc(user.isAnonymous ? FIXED_TEACHER_ID : user.uid, 'my_quizzes', id)); };

        // --- EDITOR ---
        window.initCreateMode = () => {
            editingQuizId = null; questions = []; currentVideoId = "";
            document.getElementById('editor-yt-url').value = "";
            document.getElementById('editor-video-prompt').classList.remove('hidden');
            document.getElementById('editor-video-container').innerHTML = "";
            window.switchScreen('editor');
            window.renderEditorQuestions();
        };

        window.initEditMode = (id) => {
            const q = myQuizzes.find(x => x.id === id); if(!q) return;
            editingQuizId = id; questions = [...q.questions]; currentVideoId = q.v;
            document.getElementById('editor-video-prompt').classList.add('hidden');
            window.switchScreen('editor');
            window.renderEditorQuestions();
            window.loadEditorVideo(q.v);
        };

        window.loadEditorVideo = (vId = null) => {
            const id = vId || document.getElementById('editor-yt-url').value.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/)?.[1];
            if(!id) return window.showMessage("–ì—Ä–µ—à–µ–Ω –ª–∏–Ω–∫", "error");
            currentVideoId = id;
            document.getElementById('editor-video-prompt').classList.add('hidden');
            document.getElementById('editor-video-container').innerHTML = '<div id="e-player"></div>';
            player = new YT.Player('e-player', { videoId: id, playerVars: { controls: 1, rel: 0 } });
            setInterval(() => {
                if(player && player.getCurrentTime) {
                    const t = Math.floor(player.getCurrentTime()), m = Math.floor(t/60), s = t%60;
                    document.getElementById('editor-timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                }
            }, 500);
        };

        window.openQuestionModal = (idx = -1) => {
            editingQuestionIdx = idx;
            if(player && player.pauseVideo) player.pauseVideo();
            if(idx !== -1) {
                const q = questions[idx];
                document.getElementById('m-q-text').value = q.text;
                document.getElementById('m_q_time').value = q.time;
                document.getElementById('m-q-type').value = q.type;
                document.getElementById('m-q-points').value = q.points || 1;
            } else {
                document.getElementById('m-q-text').value = "";
                document.getElementById('m_q_time').value = player ? Math.floor(player.getCurrentTime()) : 0;
                document.getElementById('m-q-type').value = "single";
                document.getElementById('m-q-points').value = 1;
            }
            window.updateModalFields();
            document.getElementById('modal-q').classList.remove('hidden');
            document.getElementById('modal-q').classList.add('flex');
        };

        window.closeQuestionModal = () => document.getElementById('modal-q').classList.add('hidden');

        window.updateModalFields = () => {
            const t = document.getElementById('m-q-type').value, area = document.getElementById('m-q-opts-area'), q = editingQuestionIdx !== -1 ? questions[editingQuestionIdx] : null;
            area.innerHTML = '';
            if(['single', 'multiple', 'ordering'].includes(t)) {
                for(let i=0; i<4; i++) {
                    area.innerHTML += `
                    <div class="flex gap-4 items-center bg-slate-50 p-4 rounded-2xl border-2 border-slate-100">
                        <input type="${t==='single'?'radio':'checkbox'}" name="q-ans" value="${i}" ${q && ((t==='single' && q.correct === i) || (t==='multiple' && (Array.isArray(q.correct) && q.correct.includes(i)))) ? 'checked' : ''} class="w-8 h-8 accent-brand-600">
                        <input type="text" class="q-opt w-full p-3 bg-white rounded-xl border border-slate-200 font-black uppercase text-sm" placeholder="–û–ø—Ü–∏—è ${i+1}" value="${q && q.options[i] ? q.options[i] : ''}">
                    </div>`;
                }
            } else if(t === 'boolean') {
                area.innerHTML = `<div class="flex gap-4"><label class="flex-1 p-6 bg-emerald-50 rounded-3xl border-2 border-emerald-100 flex items-center justify-center gap-2 font-black text-emerald-700 uppercase tracking-widest cursor-pointer"><input type="radio" name="b-val" value="true" checked> –í—è—Ä–Ω–æ</label><label class="flex-1 p-6 bg-rose-50 rounded-3xl border-2 border-rose-100 flex items-center justify-center gap-2 font-black text-rose-700 uppercase tracking-widest cursor-pointer"><input type="radio" name="b-val" value="false"> –ì—Ä–µ—à–Ω–æ</label></div>`;
            } else if (t === 'timeline') {
                area.innerHTML = `
                <div class="grid grid-cols-3 gap-4">
                   <input type="number" id="tl_min" class="p-4 border-2 rounded-xl font-bold text-center" placeholder="–ù–∞—á–∞–ª–æ" value="${q?.min||1800}">
                   <input type="number" id="tl_max" class="p-4 border-2 rounded-xl font-bold text-center" placeholder="–ö—Ä–∞–π" value="${q?.max||2000}">
                   <input type="number" id="tl_step" class="p-4 border-2 rounded-xl font-bold text-center" placeholder="–°—Ç—ä–ø–∫–∞" value="${q?.step||10}">
                </div>
                <div class="p-4 bg-slate-100 rounded-3xl text-center mt-4"><p class="text-xs font-black uppercase mb-2">–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</p><input type="number" id="num_ans" class="w-full p-4 border-4 rounded-[2rem] font-black text-4xl text-center outline-none" value="${q?.correct||1900}"></div>`;
            } else {
                area.innerHTML = `<div class="p-6 bg-slate-100 rounded-3xl text-center"><p class="text-xs font-black mb-4 uppercase text-slate-400">–ü–æ—Å–æ—á–µ—Ç–µ –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä (0-100)</p><input type="number" id="num_ans" class="w-full p-6 border-4 rounded-[2rem] font-black text-5xl text-center text-brand-600 outline-none uppercase uppercase" value="${q?q.correct:50}"></div>`;
            }
        };

        window.saveCurrentQuestion = () => {
            const text = document.getElementById('m-q-text').value.trim();
            const time = parseInt(document.getElementById('m_q_time').value);
            const type = document.getElementById('m-q-type').value;
            const points = parseInt(document.getElementById('m-q-points').value) || 1;
            if(!text) return window.showMessage("–í—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å", "error");
            let qData = { text, time, type, points };
            if(['single', 'multiple', 'ordering'].includes(type)) {
                qData.options = Array.from(document.querySelectorAll('.q-opt')).map(i => i.value.trim() || "–û–ø—Ü–∏—è");
                if(type === 'single') qData.correct = parseInt(document.querySelector('input[name="q-ans"]:checked')?.value || 0);
                else qData.correct = Array.from(document.querySelectorAll('input[name="q-ans"]:checked')).map(i => parseInt(i.value));
            } else if(type === 'boolean') qData.correct = document.querySelector('input[name="b-val"]:checked').value === 'true', qData.options = ["–í—è—Ä–Ω–æ", "–ì—Ä–µ—à–Ω–æ"];
            else if(type === 'timeline') {
                qData.correct = parseInt(document.getElementById('num_ans').value);
                qData.min = parseInt(document.getElementById('tl_min').value);
                qData.max = parseInt(document.getElementById('tl_max').value);
                qData.step = parseInt(document.getElementById('tl_step').value);
            } else qData.correct = parseInt(document.getElementById('num_ans').value), qData.options = ["0", "100"];

            if(editingQuestionIdx !== -1) questions[editingQuestionIdx] = qData;
            else questions.push(qData);
            questions.sort((a,b) => a.time - b.time);
            window.renderEditorQuestions();
            document.getElementById('modal-q').classList.add('hidden');
        };

        window.renderEditorQuestions = () => {
            const list = document.getElementById('editor-q-list');
            list.innerHTML = questions.map((q, i) => `
            <div class="p-6 bg-white border-2 border-slate-100 rounded-[2rem] shadow-sm flex items-center justify-between group transform hover:scale-[1.01] transition-all">
                <div class="flex items-center gap-5">
                    <span class="w-14 h-14 bg-brand-50 text-brand-600 rounded-2xl flex items-center justify-center font-mono font-black text-xs border-2 border-brand-100 shadow-inner">${Math.floor(q.time/60)}:${q.time%60<10?'0':''}${q.time%60}</span>
                    <div><span class="block truncate w-40 font-black text-slate-800 text-lg leading-tight uppercase tracking-tight uppercase">${q.text}</span><span class="text-[9px] uppercase font-black text-slate-400 tracking-widest uppercase uppercase">${q.type} ‚Ä¢ ${q.points}—Ç.</span></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.openQuestionModal(${i})" class="p-3 text-brand-600 hover:bg-brand-50 rounded-xl transition-colors"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                    <button onclick="questions.splice(${i},1); window.renderEditorQuestions();" class="p-3 text-rose-500 hover:bg-rose-50 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            </div>`).join('');
            lucide.createIcons();
        };

        window.finalizeAndSaveQuiz = async () => {
            if(!currentVideoId || questions.length === 0) return window.showMessage("–ù–µ–ø—ä–ª–Ω–∏ –¥–∞–Ω–Ω–∏", "error");
            let title = prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:", editingQuizId ? myQuizzes.find(x=>x.id===editingQuizId).title : "");
            if(!title) return;
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            const data = { title, v: currentVideoId, questions, owner: uid, updatedAt: serverTimestamp() };
            try {
                if(editingQuizId) await updateDoc(getUserDoc(uid, 'my_quizzes', editingQuizId), data);
                else {
                    data.createdAt = serverTimestamp();
                    await addDoc(getUserCollection(uid, 'my_quizzes'), data);
                }
                window.showMessage("–ó–∞–ø–∞–∑–µ–Ω–æ!"); window.switchScreen('dashboard');
            } catch(e) { window.showMessage("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å!", "error"); }
        };

        // --- SOLO MODE (LEVEL 1) ---
        window.startIndividual = async () => {
            const code = document.getElementById('ind-quiz-code').value.trim();
            const name = document.getElementById('ind-student-name').value.trim();
            if(!code || !name) return window.showMessage("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ –∏ –∫–æ–¥", "error");
            try {
                const dec = JSON.parse(decodeURIComponent(escape(atob(code))));
                currentQuiz = dec; sopEnabled = document.getElementById('ind-sop-mode').checked; isDiscussion = document.getElementById('ind-discussion-mode').checked;
                currentStudentName = name; liveScore = 0; liveActiveQIdx = -1;
                
                if(!auth.currentUser) await signInAnonymously(auth);
                
                window.switchScreen('solve');
                
                // Request Full Screen
                try {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
                        document.documentElement.webkitRequestFullscreen();
                    } else if (document.documentElement.msRequestFullscreen) { /* IE11 */
                        document.documentElement.msRequestFullscreen();
                    }
                } catch(e) { console.log("Fullscreen blocked", e); }

                document.getElementById('solve-player-container').innerHTML = '<div id="s-player"></div>';
                solvePlayer = new YT.Player('s-player', {
                    videoId: dec.v, width: '100%', height: '100%', playerVars: { autoplay: 1, controls: 1, rel: 0 },
                    events: { 'onStateChange': (e) => {
                        if(e.data === 1) {
                            const interval = setInterval(() => {
                                if(!solvePlayer?.getCurrentTime) return clearInterval(interval);
                                const t = Math.floor(solvePlayer.getCurrentTime());
                                const qIdx = dec.q.findIndex((q, idx) => Math.abs(q.time - t) <= 1 && idx > liveActiveQIdx);
                                if(qIdx !== -1) {
                                    liveActiveQIdx = qIdx;
                                    solvePlayer.pauseVideo();
                                    window.triggerSoloQuestion(dec.q[qIdx]);
                                }
                                if(solvePlayer.getDuration() > 0 && t >= solvePlayer.getDuration() - 1) window.finishSoloGame();
                            }, 500);
                        }
                    }}
                });
            } catch(e) { window.showMessage("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –∫–æ–¥!", "error"); }
        };

        window.triggerSoloQuestion = (q) => {
            const overlay = document.getElementById('ind-overlay');
            overlay.classList.remove('hidden'); 
            overlay.classList.add('flex');
            const qText = document.getElementById('ind-overlay-q-text');
            qText.innerText = q.text;
            
            if(sopEnabled) {
                qText.classList.add('sop-text');
                document.getElementById('ind-speak-btn').classList.remove('hidden');
                window.speakQ(q.text);
            } else {
                qText.classList.remove('sop-text');
                document.getElementById('ind-speak-btn').classList.add('hidden');
            }
            
            const area = document.getElementById('ind-overlay-options'); area.innerHTML = '';
            window.tempSelected = null;
            document.getElementById('ind-confirm-btn').classList.add('hidden');
            window.renderOptionsUI(q, area, 'solo');
        };

        window.renderOptionsUI = (q, area, mode) => {
             const baseClass = mode === 'solo' 
                ? `p-8 bg-white/10 hover:bg-white/20 border border-white/20 rounded-[2.5rem] text-white font-black text-xl backdrop-blur-xl transition-all uppercase ${sopEnabled ? 'sop-btn' : ''}`
                : `client-opt p-8 bg-white border-4 border-slate-100 rounded-[2.5rem] font-black text-2xl text-slate-800 shadow-xl transition-all uppercase`;
             
             if(['single', 'multiple', 'boolean'].includes(q.type)) {
                q.options.forEach((o, i) => {
                    area.innerHTML += `<button onclick="window.selectOpt(this, ${i}, '${q.type}', '${mode}')" class="${baseClass}">${o}</button>`;
                });
             } else if(q.type === 'timeline') {
                const textColor = mode === 'solo' ? 'text-white' : 'text-slate-800';
                area.innerHTML = `
                <div class="bg-white/10 p-10 rounded-[3rem] text-center w-full uppercase uppercase">
                    <input type="range" min="${q.min}" max="${q.max}" step="${q.step}" value="${q.min}" class="w-full h-12 mb-8 cursor-pointer" oninput="document.getElementById('val_${mode}').innerText=this.value; window.tempSelected=parseInt(this.value); document.getElementById('${mode === 'solo' ? 'ind' : 'client'}-confirm-btn').classList.remove('hidden');">
                    <div id="val_${mode}" class="text-9xl font-black ${textColor} drop-shadow-xl tracking-tighter uppercase uppercase">${q.min}</div>
                </div>`;
             } else if (q.type === 'numeric') {
                const textColor = mode === 'solo' ? 'text-white' : 'text-slate-800';
                area.innerHTML = `
                <div class="bg-white/10 p-10 rounded-[3rem] text-center w-full uppercase uppercase">
                    <input type="range" min="0" max="100" class="w-full h-12 mb-8 cursor-pointer" oninput="document.getElementById('val_${mode}').innerText=this.value; window.tempSelected=parseInt(this.value); document.getElementById('${mode === 'solo' ? 'ind' : 'client'}-confirm-btn').classList.remove('hidden');">
                    <div id="val_${mode}" class="text-9xl font-black ${textColor} drop-shadow-xl tracking-tighter uppercase uppercase">50</div>
                </div>`;
             }
        };

        window.selectOpt = (el, i, type, mode) => {
            const btnClass = mode === 'solo' ? 'bg-brand-600 border-brand-400 shadow-2xl' : 'bg-brand-600 text-white border-brand-400';
            const baseClass = mode === 'solo' ? 'bg-white/10 border-white/20' : 'bg-white border-slate-100 text-slate-800';
            
            // Remove selection if single/boolean
            if(type !== 'multiple') {
                const btns = mode === 'solo' ? document.querySelectorAll('#ind-overlay-options button') : document.querySelectorAll('#client-options button');
                btns.forEach(b => {
                    b.classList.remove(...btnClass.split(' '));
                    b.classList.add(...baseClass.split(' '));
                });
            }
            // Add selection
            el.classList.remove(...baseClass.split(' '));
            el.classList.add(...btnClass.split(' '));
            
            if(type === 'multiple') {
                window.tempSelected = window.tempSelected || [];
                if(window.tempSelected.includes(i)) window.tempSelected = window.tempSelected.filter(x => x !== i);
                else window.tempSelected.push(i);
            } else window.tempSelected = i;
            
            document.getElementById(`${mode === 'solo' ? 'ind' : 'client'}-confirm-btn`).classList.remove('hidden');
        };

        window.confirmSoloAnswer = () => {
            const q = currentQuiz.q[liveActiveQIdx];
            let isCorrect = false;
            if(['single', 'boolean', 'numeric', 'timeline'].includes(q.type)) isCorrect = (window.tempSelected == q.correct);
            else if(q.type === 'multiple') isCorrect = (JSON.stringify(window.tempSelected?.sort()) === JSON.stringify(q.correct?.sort()));
            else isCorrect = true; // ordering simplified

            if(isCorrect) liveScore += (q.points || 1);
            document.getElementById('ind-overlay').classList.add('hidden');
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            solvePlayer.playVideo();
        };

        window.finishSoloGame = async () => {
            window.switchScreen('finish');
            const total = currentQuiz.q.reduce((a,b) => a + (b.points||1), 0);
            document.getElementById('res-score').innerText = `${liveScore} / ${total}`;
            // If discussion mode, DO NOT save results.
            if(!isDiscussion && auth.currentUser) {
                try {
                    const ownerId = currentQuiz.owner || FIXED_TEACHER_ID;
                    // WRITE TO PUBLIC SHARED COLLECTION so teacher can read it later
                    await addDoc(getPublicCollection('solo_results'), {
                        teacherId: ownerId,
                        studentName: currentStudentName, 
                        quizTitle: currentQuiz.title, 
                        score: `${liveScore}/${total}`, 
                        timestamp: serverTimestamp()
                    });
                } catch(e) { console.error("Could not save solo result:", e); }
            } else {
                 console.log("Discussion Mode: No stats saved.");
            }
        };

        window.speakQ = (t) => { if('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(t || document.getElementById('ind-overlay-q-text').innerText); u.lang = 'bg-BG'; u.rate = 0.8; window.speechSynthesis.speak(u); } };

        // --- HOST ---
        window.startLiveSessionHost = async (id) => {
            const q = myQuizzes.find(x => x.id === id); currentQuiz = q;
            sessionID = Math.floor(1000 + Math.random() * 9000).toString();
            window.switchScreen('live-host');
            document.getElementById('host-pin-display').innerText = sessionID;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?pin=' + sessionID)}`;
            document.getElementById('host-qr-container').innerHTML = `<img src="${qrUrl}" class="w-full h-full rounded-3xl ring-8 ring-slate-100">`;
            
            await setDoc(getPublicDoc('sessions', sessionID), {
                status: 'waiting', pin: sessionID, quizTitle: q.title, activeQ: -1, timestamp: serverTimestamp(), totalQs: q.questions.length
            });

            if(unsubscribes.participants) unsubscribes.participants();
            unsubscribes.participants = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID, 'participants'), s => {
                liveParticipants = s.docs.map(d => ({ ...d.data(), uid: d.id }));
                window.renderHostLiveUI();
            }, e => console.error("Snapshot error (participants):", e));
        };

        window.renderHostLiveUI = () => {
            document.getElementById('host-count').innerText = liveParticipants.length;
            const sorted = [...liveParticipants].sort((a,b) => (b.score||0) - (a.score||0));
            document.getElementById('host-leaderboard').innerHTML = sorted.map((p, i) => `
            <div class="bg-white/10 p-5 rounded-3xl flex items-center justify-between border border-white/5 animate-pop shadow-xl backdrop-blur-md">
                <div class="flex items-center gap-4">
                    <span class="w-8 font-black text-white/30 text-xs">#${i+1}</span>
                    <span class="text-3xl">${p.avatar||'üòé'}</span>
                    <span class="font-black text-white text-lg truncate w-32 uppercase">${p.name}</span>
                </div>
                <div class="bg-emerald-500/20 px-4 py-2 rounded-xl border border-emerald-500/30"><span class="font-black text-emerald-400 text-2xl tracking-tighter">${p.score||0}</span></div>
            </div>`).join('');
            
            const totalPossible = (liveParticipants.length || 1) * currentQuiz.questions.length;
            const answers = liveParticipants.reduce((s,p)=>s+(p.ansCount||0),0);
            const p = Math.round((answers/totalPossible)*100);
            document.getElementById('host-progress-bar').style.width = p + '%';
            document.getElementById('host-progress-text').innerText = p + '%';
        };

        window.startLiveVideo = () => {
            document.getElementById('host-start-overlay').classList.add('hidden');
            document.getElementById('host-player-container').innerHTML = '<div id="h-player"></div>';
            hostPlayer = new YT.Player('h-player', {
                videoId: currentQuiz.v, playerVars: { autoplay: 1, controls: 0, disablekb: 1, rel: 0 },
                events: { 'onStateChange': (e) => {
                    if(e.data === 1) {
                        const interval = setInterval(() => {
                            if(!hostPlayer?.getCurrentTime) return clearInterval(interval);
                            const t = Math.floor(hostPlayer.getCurrentTime());
                            const qIdx = currentQuiz.questions.findIndex(q => Math.abs(q.time - t) <= 1);
                            if(qIdx !== -1 && qIdx !== liveActiveQIdx) {
                                liveActiveQIdx = qIdx; hostPlayer.pauseVideo();
                                document.getElementById('host-resume-overlay').classList.remove('hidden');
                                updateDoc(getPublicDoc('sessions', sessionID), {
                                    status: 'active', activeQ: qIdx, qData: currentQuiz.questions[qIdx]
                                });
                            }
                        }, 1000);
                    }
                }}
            });
        };

        window.resumeLiveVideo = () => {
            document.getElementById('host-resume-overlay').classList.add('hidden');
            updateDoc(getPublicDoc('sessions', sessionID), { status: 'playing' });
            hostPlayer.playVideo();
        };

        window.finishSession = async () => {
            if(!confirm("–ö—Ä–∞–π –Ω–∞ —Å–µ—Å–∏—è—Ç–∞?")) return;
            await updateDoc(getPublicDoc('sessions', sessionID), { status: 'finished' });
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            await addDoc(getUserCollection(uid, 'class_history'), {
                title: currentQuiz.title, pin: sessionID, timestamp: serverTimestamp(), participants: liveParticipants
            });
            window.switchScreen('dashboard');
        };

        window.quitHostSession = () => window.switchScreen('dashboard');

        // --- CLIENT ---
        window.joinLiveSession = async () => {
            const pin = document.getElementById('live-pin').value.trim();
            const name = document.getElementById('live-student-name').value.trim();
            if(!pin || !name) return window.showMessage("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏", "error");
            if(!auth.currentUser) await signInAnonymously(auth);
            
            const snap = await getDoc(getPublicDoc('sessions', pin));
            if(!snap.exists()) return window.showMessage("–ì—Ä–µ—à–µ–Ω –ü–ò–ù!", "error");
            
            sessionID = pin; const avatar = EMOTICONS[Math.floor(Math.random()*EMOTICONS.length)];
            document.getElementById('client-avatar').innerText = avatar; 
            document.getElementById('client-name-badge').innerText = name;
            window.switchScreen('live-client');
            
            const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants', auth.currentUser.uid);
            await setDoc(pRef, { name, avatar, score: 0, uid: auth.currentUser.uid, ansCount: 0 });
            
            if(unsubscribes.session) unsubscribes.session();
            unsubscribes.session = onSnapshot(getPublicDoc('sessions', pin), s => {
                const d = s.data(); if(!d) return;
                if(d.status === 'finished') {
                    document.getElementById('client-question').classList.add('hidden');
                    document.getElementById('client-finished').classList.remove('hidden');
                    document.getElementById('client-final-score').innerText = liveScore;
                } else if(d.status === 'active' && d.activeQ !== lastClientAnsweredIdx) {
                    currentLiveQ = d.qData; liveActiveQIdx = d.activeQ; window.renderClientQuestion(d.qData);
                } else if(d.status === 'playing' || d.status === 'waiting') {
                    document.getElementById('client-question').classList.add('hidden');
                    document.getElementById('client-waiting').classList.remove('hidden');
                }
            }, e => console.error("Error session client:", e));
        };

        window.renderClientQuestion = (q) => {
            document.getElementById('client-waiting').classList.add('hidden'); 
            document.getElementById('client-question').classList.remove('hidden');
            document.getElementById('client-q-text').innerText = q.text; 
            const area = document.getElementById('client-options'); area.innerHTML = '';
            window.tempSelected = null;
            document.getElementById('client-confirm-btn').classList.add('hidden');
            window.renderOptionsUI(q, area, 'client');
        };

        window.submitLiveAnswer = async () => {
            let isCorrect = false;
            if(JSON.stringify(window.tempSelected) == JSON.stringify(currentLiveQ.correct)) isCorrect = true;
            
            if(isCorrect) liveScore += (currentLiveQ.points || 1);
            lastClientAnsweredIdx = liveActiveQIdx;
            const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID, 'participants', auth.currentUser.uid);
            await updateDoc(pRef, { score: liveScore, ansCount: liveActiveQIdx + 1 });
            document.getElementById('client-question').classList.add('hidden');
            document.getElementById('client-waiting').classList.remove('hidden');
        };

        // --- STATS ---
        window.switchHistoryTab = (t) => {
            activeHistoryTab = t;
            document.getElementById('h-tab-solo').className = t === 'solo' ? "px-8 py-3 rounded-xl font-black text-xs bg-brand-600 text-white shadow-xl transition-all uppercase" : "px-8 py-3 rounded-xl font-black text-xs text-slate-400 uppercase";
            document.getElementById('h-tab-class').className = t === 'class' ? "px-8 py-3 rounded-xl font-black text-xs bg-brand-600 text-white shadow-xl transition-all uppercase" : "px-8 py-3 rounded-xl font-black text-xs text-slate-400 uppercase";
            
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;

            if(t === 'solo') {
                if(unsubscribes.soloStats) unsubscribes.soloStats();
                try {
                    unsubscribes.soloStats = onSnapshot(getPublicCollection('solo_results'), snapshot => {
                       const allResults = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                       const myResults = allResults.filter(r => r.teacherId === uid);
                       window.renderStatsTable(myResults, 'solo');
                    }, e => console.error("Snapshot error (solo):", e));
                } catch(e) { console.error("Solo stats error", e); }
            } else {
                if(unsubscribes.classStats) unsubscribes.classStats();
                try {
                    unsubscribes.classStats = onSnapshot(getUserCollection(uid, 'class_history'), s => {
                        window.renderStatsTable(s.docs.map(d => ({...d.data(), id: d.id})), 'class');
                    }, e => console.error("Snapshot error (class):", e));
                } catch(e) { console.error("Class stats error", e); }
            }
        };

        window.renderStatsTable = (data, type) => {
            const head = document.getElementById('history-head');
            const body = document.getElementById('history-body');
            head.innerHTML = type === 'solo' 
                ? '<th class="p-8 pl-10">–£—á–µ–Ω–∏–∫</th><th class="p-8">–£—Ä–æ–∫</th><th class="p-8">–†–µ–∑—É–ª—Ç–∞—Ç</th><th class="p-8 text-center">–î–µ–π—Å—Ç–≤–∏–µ</th>'
                : '<th class="p-8 pl-10">–î–∞—Ç–∞</th><th class="p-8">–£—Ä–æ–∫</th><th class="p-8">–ü–ò–ù</th><th class="p-8 text-center">–î–µ–π—Å—Ç–≤–∏–µ</th>';
            
            body.innerHTML = data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).map(r => `
                <tr class="hover:bg-slate-50 transition-colors uppercase font-black text-[10px] tracking-widest uppercase">
                    <td class="p-8 pl-10 text-slate-800">${type==='solo'?r.studentName:window.formatDate(r.timestamp)}</td>
                    <td class="p-8 text-slate-500 font-bold">${r.quizTitle || r.title}</td>
                    <td class="p-8 text-brand-600 font-black">${type==='solo'?r.score:r.pin}</td>
                    <td class="p-8 text-center flex justify-center gap-3">
                        <button onclick="window.viewStat('${r.id}', '${type}')" class="p-3 bg-brand-50 text-brand-600 rounded-xl" title="–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è"><i data-lucide="eye"></i></button>
                        <button onclick="window.exportStat('${r.id}', '${type}', 'xlsx')" class="p-3 bg-emerald-50 text-emerald-600 rounded-xl" title="Excel"><i data-lucide="file-spreadsheet"></i></button>
                        <button onclick="window.deleteStat('${r.id}', '${type}')" class="p-3 bg-rose-50 text-rose-500 rounded-xl" title="–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        };

        window.viewStat = async (id, type) => {
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            const docRef = type === 'solo' ? getPublicDoc('solo_results', id) : getUserDoc(uid, 'class_history', id);
            
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const data = snap.data();
            document.getElementById('stat-view-title').innerText = data.quizTitle || data.title;
            const body = document.getElementById('stat-view-body');
            if(type === 'solo') body.innerHTML = `<tr><td class="p-6 pl-8 font-black uppercase">${data.studentName}</td><td class="p-6 text-right font-black text-brand-600">${data.score}</td></tr>`;
            else body.innerHTML = (data.participants || []).map(p => `<tr><td class="p-6 pl-8 font-black uppercase">${p.name}</td><td class="p-6 text-right font-black text-brand-600">${p.score}</td></tr>`).join('');
            document.getElementById('modal-view-stat').classList.remove('hidden');
            document.getElementById('modal-view-stat').classList.add('flex');
        };

        window.exportStat = async (id, type, format) => {
             const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
             const docRef = type === 'solo' ? getPublicDoc('solo_results', id) : getUserDoc(uid, 'class_history', id);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const data = snap.data();
            const list = type === 'solo' ? [{–ò–º–µ: data.studentName, –†–µ–∑—É–ª—Ç–∞—Ç: data.score}] : (data.participants || []).map(p => ({–ò–º–µ: p.name, –†–µ–∑—É–ª—Ç–∞—Ç: p.score}));
            const ws = XLSX.utils.json_to_sheet(list);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "–†–µ–∑—É–ª—Ç–∞—Ç–∏");
            XLSX.writeFile(wb, `VideoQuiz_${id}.xlsx`);
        };

        window.deleteStat = async (id, type) => { 
            if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) {
                const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
                const docRef = type === 'solo' ? getPublicDoc('solo_results', id) : getUserDoc(uid, 'class_history', id);
                await deleteDoc(docRef); 
            }
        };
        
        window.formatDate = (ts) => ts?.toDate ? ts.toDate().toLocaleDateString('bg-BG') : '...';
        
        window.onYouTubeIframeAPIReady = () => console.log("YT READY");
        window.addEventListener('DOMContentLoaded', () => { 
            const p = new URLSearchParams(window.location.search).get('pin'); 
            if(p) { window.switchTab('class'); document.getElementById('live-pin').value = p; } 
        });
    </script>
</body>
</html>
