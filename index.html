<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VideoQuiz Ultimate Pro</title>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Nunito', 'sans-serif'] }, 
                    colors: { brand: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' } } 
                } 
            } 
        }
    </script>

    <style>
        body { font-family: 'Nunito', sans-serif; -webkit-font-smoothing: antialiased; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* SOP & Visuals */
        .sop-text { font-size: 2rem !important; line-height: 1.3 !important; font-weight: 900; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        /* Custom Slider Timeline */
        .timeline-slider { -webkit-appearance: none; width: 100%; height: 12px; background: #e2e8f0; border-radius: 99px; outline: none; }
        .timeline-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; width: 32px; height: 32px; border-radius: 50%; 
            background: #4f46e5; cursor: pointer; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
            transition: transform 0.1s;
        }
        .timeline-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        /* Bubble for Timeline */
        .range-bubble {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: #4f46e5; color: white; padding: 8px 16px; border-radius: 16px;
            font-weight: 900; font-size: 1.5rem; pointer-events: none; opacity: 1; transition: left 0.1s ease-out;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .range-bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid; border-color: #4f46e5 transparent transparent transparent;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden selection:bg-brand-100">

    <div id="app" class="h-full flex flex-col relative">
        <!-- Loader -->
        <div id="auth-loader" class="fixed inset-0 bg-white z-[10000] flex items-center justify-center flex-col gap-6">
            <div class="w-16 h-16 border-4 border-brand-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="font-black text-brand-900 tracking-widest uppercase text-xs">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
        </div>

        <div id="msg-container" class="fixed top-6 right-6 z-[10001] flex flex-col items-end pointer-events-none gap-2"></div>

        <!-- 1. –í–•–û–î (–°–¢–ò–õ–ï–ù –î–ò–ó–ê–ô–ù) -->
        <div id="screen-welcome" class="flex h-full w-full bg-white relative z-10 overflow-hidden flex-col md:flex-row">
            <!-- Student Side (Light) -->
            <div class="flex-1 flex flex-col justify-center items-center p-6 bg-slate-50 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-600 to-purple-600"></div>
                <div class="w-full max-w-md space-y-8 animate-pop text-center relative z-10">
                    <div>
                        <h1 class="text-5xl font-black text-slate-900 tracking-tighter mb-2">VideoQuiz</h1>
                        <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ –æ–±—É—á–µ–Ω–∏–µ</p>
                    </div>
                    
                    <div class="bg-white p-1.5 rounded-2xl shadow-sm border border-slate-200 flex">
                        <button onclick="window.switchTab('solo')" id="tab-solo" class="flex-1 py-3 rounded-xl font-black text-sm bg-brand-600 text-white shadow-md transition-all">–°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–ù–û</button>
                        <button onclick="window.switchTab('class')" id="tab-class" class="flex-1 py-3 rounded-xl font-black text-sm text-slate-400 hover:bg-slate-50 transition-all">–í –ö–õ–ê–°</button>
                    </div>

                    <!-- Solo Panel -->
                    <div id="panel-solo" class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-xl space-y-5">
                        <input type="text" id="ind-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="input-field">
                        <input type="text" id="ind-quiz-code" placeholder="–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫–∞..." class="input-field text-center font-mono text-sm tracking-wider">
                        <div class="flex gap-3">
                            <label class="option-label group"><input type="checkbox" id="ind-sop-mode" class="accent-brand-600 w-5 h-5 group-hover:scale-110 transition-transform"> <span class="group-hover:text-brand-600 transition-colors">–°–û–ü üîä</span></label>
                            <label class="option-label group"><input type="checkbox" id="ind-discussion-mode" class="accent-amber-500 w-5 h-5 group-hover:scale-110 transition-transform"> <span class="group-hover:text-amber-600 transition-colors">–û–ë–°–™–ñ–î–ê–ù–ï</span></label>
                        </div>
                        <button onclick="window.startIndividual()" class="btn-primary w-full py-4 text-lg bg-brand-600 hover:bg-brand-700 shadow-brand-200">–°–¢–ê–†–¢</button>
                    </div>

                    <!-- Class Panel -->
                    <div id="panel-class" class="hidden bg-white p-8 rounded-[2rem] border border-emerald-100 shadow-xl space-y-5 border-t-8 border-t-emerald-500">
                        <input type="text" id="live-student-name" placeholder="–¢–≤–æ–µ—Ç–æ –ò–º–µ" class="input-field border-emerald-100 focus:border-emerald-500">
                        <input type="number" id="live-pin" placeholder="PIN" class="input-field text-center font-black text-4xl tracking-widest border-emerald-100 focus:border-emerald-500 placeholder-emerald-100/50">
                        <button onclick="window.joinLiveSession()" class="btn-primary w-full py-4 text-lg bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200">–í–õ–ï–ó</button>
                    </div>
                </div>
            </div>

            <!-- Teacher Side (Dark & Stylish) -->
            <div class="hidden md:flex w-full md:w-[450px] bg-slate-900 text-white p-12 flex-col justify-center relative overflow-hidden">
                <!-- Background decorations -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-brand-500/20 rounded-full blur-3xl -mr-32 -mt-32"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-purple-500/20 rounded-full blur-3xl -ml-24 -mb-24"></div>
                
                <div class="relative z-10 space-y-8 animate-pop">
                    <div>
                        <h2 id="auth-title" class="text-3xl font-black mb-2">–£—á–∏—Ç–µ–ª—Å–∫–∏ –í—Ö–æ–¥</h2>
                        <p class="text-slate-400 text-sm font-medium">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—á–µ–±–Ω–æ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ.</p>
                    </div>
                    <form onsubmit="event.preventDefault(); window.handleAuthSubmit();" class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">–ò–º–µ–π–ª</label>
                            <input type="email" id="auth-email" placeholder="name@school.bg" class="input-dark">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest text-slate-500 ml-1">–ü–∞—Ä–æ–ª–∞</label>
                            <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input-dark">
                        </div>
                        <div id="reg-extra" class="hidden animate-fade-in space-y-1">
                            <label class="text-[10px] font-black uppercase tracking-widest text-amber-500 ml-1">–ö–æ–¥ –∑–∞ –¥–æ—Å—Ç—ä–ø</label>
                            <input type="password" id="auth-teacher-code" placeholder="vilidaf76" class="input-dark text-center border-amber-500/30 text-amber-300 focus:border-amber-500">
                        </div>
                        <button type="submit" id="auth-btn" class="btn-primary w-full bg-brand-600 hover:bg-brand-500 border-b-4 border-brand-800 active:border-b-0 active:translate-y-1 py-4">–í–õ–ï–ó</button>
                    </form>
                    <button onclick="window.toggleAuthMode()" id="auth-toggle" class="text-xs font-bold text-slate-500 hover:text-white w-full text-center transition-colors">–ù—è–º–∞—Ç–µ –∞–∫–∞—É–Ω—Ç? <span class="text-brand-400 underline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></button>
                </div>
            </div>
            
            <!-- Mobile Toggle for Teacher View -->
            <button onclick="document.querySelector('.md\\:flex').classList.toggle('hidden'); document.querySelector('.md\\:flex').classList.toggle('flex'); this.innerText = this.innerText === '–£—á–∏—Ç–µ–ª' ? '–£—á–µ–Ω–∏–∫' : '–£—á–∏—Ç–µ–ª'" class="md:hidden absolute top-4 right-4 px-4 py-2 bg-slate-900 text-white rounded-lg text-xs font-bold z-50 shadow-lg">–£—á–∏—Ç–µ–ª</button>
        </div>

        <!-- 2. –ë–ò–ë–õ–ò–û–¢–ï–ö–ê -->
        <div id="screen-dashboard" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-20">
            <header class="bg-white border-b px-8 py-4 flex justify-between items-center shrink-0 shadow-sm sticky top-0 z-10">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-200"><i data-lucide="library" class="w-5 h-5"></i></div>
                    <h1 class="text-lg font-black uppercase tracking-tight">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.initCreateMode()" class="btn-primary px-6 py-2 text-xs flex items-center gap-2 bg-brand-600 hover:bg-brand-700 shadow-md"><i data-lucide="plus" class="w-4 h-4"></i> –ù–û–í –£–†–û–ö</button>
                    <button onclick="window.handleLogout()" class="p-2 hover:bg-slate-100 rounded-lg text-slate-400 transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-8 max-w-7xl mx-auto w-full space-y-8 pb-32">
                <div id="my-quizzes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                
                 <!-- Stats Section -->
                <section class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500"><i data-lucide="bar-chart-2" class="w-4 h-4"></i></span>
                            <h2 class="font-black text-slate-800 uppercase text-sm tracking-widest">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        </div>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                             <button onclick="window.switchHistoryTab('solo')" id="h-tab-solo" class="px-6 py-2 rounded-lg font-black text-xs bg-white shadow-sm transition-all">–ò–ù–î–ò–í–ò–î–£–ê–õ–ù–ò</button>
                             <button onclick="window.switchHistoryTab('class')" id="h-tab-class" class="px-6 py-2 rounded-lg font-bold text-xs text-slate-500 transition-all">–í –ö–õ–ê–°</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-[10px] uppercase font-black text-slate-400 border-b border-slate-100">
                                <tr id="history-head"></tr>
                            </thead>
                            <tbody id="history-body" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>

        <!-- 3. –†–ï–î–ê–ö–¢–û–† -->
        <div id="screen-editor" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-30">
            <!-- Top Bar -->
            <header class="bg-white border-b px-6 py-3 flex items-center gap-4 shrink-0 shadow-sm z-20">
                <button onclick="window.switchScreen('dashboard')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i></button>
                <div class="flex-1 flex gap-2">
                    <div class="relative flex-1 group">
                        <i data-lucide="link" class="absolute left-3 top-3 w-4 h-4 text-slate-400 group-focus-within:text-brand-500"></i>
                        <input type="text" id="editor-yt-url" placeholder="YouTube –õ–∏–Ω–∫..." class="w-full pl-10 p-2 bg-slate-50 border border-slate-200 rounded-lg font-bold text-sm outline-none focus:border-brand-500 focus:bg-white transition-all">
                    </div>
                    <button onclick="window.loadEditorVideo()" class="px-6 bg-slate-900 text-white rounded-lg font-black text-xs hover:bg-black transition-colors uppercase tracking-wider">–ó–∞—Ä–µ–¥–∏</button>
                </div>
                <button onclick="window.finalizeAndSaveQuiz()" class="px-6 py-2.5 bg-brand-600 text-white rounded-lg font-black text-xs hover:bg-brand-700 shadow-lg shadow-brand-200 uppercase tracking-wider flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> –ó–∞–ø–∞–∑–∏</button>
            </header>
            
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <!-- Left: Video & Controls -->
                <div class="flex-1 bg-white p-6 flex flex-col justify-center items-center border-r border-slate-200 overflow-y-auto">
                    <div class="w-full max-w-4xl aspect-video bg-black rounded-2xl overflow-hidden shadow-2xl relative mb-6 border-4 border-slate-100">
                        <div id="editor-video-container" class="w-full h-full"></div>
                    </div>
                    
                    <div class="w-full max-w-4xl flex items-center justify-between bg-slate-50 p-4 rounded-2xl border border-slate-100">
                         <div class="flex flex-col">
                             <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">–¢–µ–∫—É—â–æ –≤—Ä–µ–º–µ</span>
                             <div class="text-4xl font-black text-brand-600 font-mono tracking-tighter" id="editor-timer">00:00</div>
                         </div>
                         <button onclick="window.openQuestionModal()" class="px-8 py-4 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-black text-sm shadow-xl shadow-rose-200 flex items-center gap-2 transform hover:scale-105 transition-all uppercase tracking-wider">
                             <i data-lucide="plus-circle" class="w-5 h-5"></i> –î–æ–±–∞–≤–∏ –í—ä–ø—Ä–æ—Å
                         </button>
                    </div>
                </div>

                <!-- Right: Question List -->
                <div class="w-full lg:w-96 bg-slate-50 flex flex-col shrink-0 border-l border-slate-200">
                    <div class="p-4 border-b border-slate-200 font-black text-xs text-slate-400 uppercase tracking-widest text-center flex items-center justify-center gap-2"><i data-lucide="list" class="w-3 h-3"></i> –°–ø–∏—Å—ä–∫ –í—ä–ø—Ä–æ—Å–∏</div>
                    <div id="editor-q-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-20"></div>
                </div>
            </div>
        </div>

        <!-- 4. –ù–ê –ñ–ò–í–û (HOST) -->
        <div id="screen-live-host" class="hidden h-full flex flex-col bg-slate-900 absolute inset-0 z-[60]">
            <!-- Top Bar -->
            <div class="h-20 bg-slate-800 border-b border-white/10 px-6 flex justify-between items-center shrink-0 shadow-lg">
                <div class="flex items-center gap-6">
                    <div class="bg-brand-600 px-6 py-2 rounded-xl text-center shadow-lg border border-brand-400/30">
                        <span class="text-[10px] font-black text-brand-200 block uppercase tracking-widest">PIN</span>
                        <span id="host-pin-display" class="text-2xl font-black text-white leading-none tracking-tight">....</span>
                    </div>
                    <div class="text-white">
                        <div id="host-count" class="text-2xl font-black leading-none">0</div>
                        <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–£—á–µ–Ω–∏—Ü–∏</div>
                    </div>
                </div>
                <div class="flex-1 mx-8 max-w-xl">
                     <div class="flex justify-between text-[10px] text-slate-400 font-black uppercase mb-1 tracking-wider"><span>–ü—Ä–æ–≥—Ä–µ—Å</span><span id="host-progress-text">0%</span></div>
                     <div class="h-2 bg-white/10 rounded-full overflow-hidden"><div id="host-progress-bar" class="h-full bg-emerald-500 w-0 transition-all duration-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.finishSession()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-black text-xs hover:bg-emerald-500 uppercase tracking-widest shadow-lg">–ö–†–ê–ô</button>
                    <button onclick="window.quitHostSession()" class="p-2 bg-slate-700 text-slate-400 rounded-lg hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            
            <div class="flex-1 flex overflow-hidden p-6 gap-6">
                <!-- Video Container -->
                <div class="flex-1 flex flex-col justify-center bg-black rounded-3xl overflow-hidden relative shadow-2xl border border-white/10">
                    <div class="w-full aspect-video relative bg-black">
                         <div id="host-player-container" class="absolute inset-0"></div>
                         <!-- Overlays -->
                         <div id="host-start-overlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center p-8 z-30">
                            <div id="host-qr-container" class="p-2 bg-white rounded-2xl mb-6 w-40 h-40 shadow-[0_0_30px_rgba(255,255,255,0.1)]"></div>
                            <button onclick="window.startLiveVideo()" class="px-12 py-6 bg-brand-600 text-white rounded-full font-black text-3xl shadow-2xl hover:bg-brand-500 transition-all flex items-center gap-4 transform hover:scale-105 active:scale-95"><i data-lucide="play" class="w-10 h-10 fill-current"></i> –ü–£–°–ù–ò</button>
                         </div>
                         <div id="host-resume-overlay" class="hidden absolute inset-0 bg-slate-900/90 flex flex-col items-center justify-center z-40 text-center backdrop-blur-sm">
                            <h3 class="text-white text-4xl font-black mb-8 uppercase tracking-tight">–í—ä–ø—Ä–æ—Å—ä—Ç –µ –∞–∫—Ç–∏–≤–µ–Ω!</h3>
                            <button onclick="window.resumeLiveVideo()" class="px-12 py-5 bg-emerald-500 text-white rounded-full font-black text-2xl hover:bg-emerald-400 shadow-2xl transition-all border-b-8 border-emerald-700 active:border-b-0 active:translate-y-2 uppercase tracking-widest">–ü–†–û–î–™–õ–ñ–ò</button>
                         </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="w-80 bg-slate-800 rounded-3xl border border-white/5 flex flex-col overflow-hidden shrink-0 shadow-xl">
                    <div class="p-4 border-b border-white/5 font-black text-slate-500 uppercase text-xs text-center tracking-[0.2em]">–ö–ª–∞—Å–∞—Ü–∏—è</div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-hide" id="host-leaderboard"></div>
                </div>
            </div>
        </div>

        <!-- 5. –£–ß–ï–ù–ò–ö (CLIENT) -->
        <div id="screen-live-client" class="hidden h-full flex flex-col bg-slate-50 absolute inset-0 z-[70] overflow-hidden">
             <div id="client-waiting" class="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8 animate-pop">
                 <div class="text-8xl animate-bounce filter drop-shadow-lg">‚è≥</div>
                 <div class="space-y-2">
                     <h2 class="text-3xl font-black text-slate-800 uppercase tracking-tight">–ò–∑—á–∞–∫–∞–π –≤—ä–ø—Ä–æ—Å–∞...</h2>
                     <p class="text-slate-500 font-bold">–ì–ª–µ–¥–∞–π –∫—ä–º –µ–∫—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏—Ç–µ–ª—è</p>
                 </div>
             </div>
             
             <div id="client-question" class="hidden flex-1 flex flex-col p-6 overflow-y-auto pb-32">
                 <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 mb-8 text-center">
                     <h2 id="client-q-text" class="text-2xl font-black text-slate-800 leading-tight">...</h2>
                 </div>
                 <div id="client-options" class="grid gap-4 w-full max-w-md mx-auto"></div>
             </div>

             <div id="client-confirm-bar" class="hidden fixed bottom-0 left-0 w-full p-6 bg-white border-t border-slate-200 z-[100] shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
                 <button onclick="window.submitLiveAnswer()" class="w-full py-4 bg-brand-600 text-white rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all uppercase tracking-widest">–ü–û–¢–í–™–†–î–ò</button>
             </div>
             
             <div id="client-finished" class="hidden flex-1 flex flex-col items-center justify-center p-8 bg-brand-600 text-white z-[80]">
                 <h1 class="text-5xl font-black mb-6 uppercase tracking-tighter">–†–ï–ó–£–õ–¢–ê–¢</h1>
                 <div class="w-48 h-48 bg-white/20 rounded-full flex flex-col items-center justify-center border-4 border-white/30 backdrop-blur-md mb-8">
                    <div class="text-8xl font-black" id="client-final-score">0</div>
                    <div class="text-xs font-black uppercase tracking-widest opacity-80">–¢–û–ß–ö–ò</div>
                 </div>
                 <button onclick="location.reload()" class="mt-4 px-10 py-4 bg-white text-brand-600 rounded-2xl font-black uppercase shadow-xl active:scale-95 transition-all">–ò–ó–•–û–î</button>
             </div>
        </div>

        <!-- MODALS -->
        <!-- Edit Question (Simplified) -->
        <div id="modal-q" class="hidden fixed inset-0 bg-black/80 z-[200] items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden animate-pop transform scale-95 transition-all">
                <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="font-black text-lg text-slate-800 uppercase tracking-wider">–†–µ–¥–∞–∫—Ü–∏—è</h3>
                    <button onclick="window.closeQuestionModal()" class="text-slate-400 hover:text-rose-500 transition-colors"><i data-lucide="x"></i></button>
                </div>
                <div class="p-6 space-y-5">
                     <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">–¢–µ–∫—Å—Ç –Ω–∞ –≤—ä–ø—Ä–æ—Å–∞</label>
                        <textarea id="m-q-text" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≤—ä–ø—Ä–æ—Å–∞..." class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none h-28 resize-none focus:border-brand-500 focus:bg-white transition-colors text-lg"></textarea>
                     </div>
                     <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">–¢–∏–ø –æ—Ç–≥–æ–≤–æ—Ä</label>
                        <select id="m-q-type" onchange="window.updateModalFields()" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-brand-500"><option value="single">–ï–¥–∏–Ω –≤–µ—Ä–µ–Ω</option><option value="boolean">–í—è—Ä–Ω–æ/–ì—Ä–µ—à–Ω–æ</option><option value="numeric">–ß–∏—Å–ª–æ–≤ –ü–ª—ä–∑–≥–∞—á</option><option value="timeline">–•—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ–Ω –ü–ª—ä–∑–≥–∞—á</option><option value="ordering">–ü–æ–¥—Ä–µ–∂–¥–∞–Ω–µ</option></select>
                     </div>
                     <div id="m-q-opts-area" class="space-y-3"></div>
                </div>
                <div class="p-6 border-t bg-slate-50">
                    <button onclick="window.saveCurrentQuestion()" class="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black shadow-lg uppercase tracking-widest transition-all active:scale-95">–ó–ê–ü–ê–ó–ò</button>
                </div>
            </div>
        </div>

        <!-- Share Modal (Screenshot 3 Style) -->
        <div id="modal-share" class="hidden fixed inset-0 bg-black/90 z-[200] items-center justify-center p-4 backdrop-blur-md">
             <div class="bg-white rounded-[2rem] shadow-2xl p-8 max-w-md w-full text-center animate-pop">
                 <div class="w-16 h-16 bg-brand-100 text-brand-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><i data-lucide="link" class="w-8 h-8"></i></div>
                 <h3 class="text-2xl font-black text-slate-900 mb-2">–ö–æ–¥ –Ω–∞ —É—Ä–æ–∫–∞</h3>
                 <p class="text-slate-500 text-sm font-bold mb-6">–ö–æ–ø–∏—Ä–∞–π—Ç–µ –∏ –∏–∑–ø—Ä–∞—Ç–µ—Ç–µ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –∑–∞ –¥–æ–º–∞—à–Ω–∞ —Ä–∞–±–æ—Ç–∞.</p>
                 <div class="relative mb-6 group">
                    <textarea id="share-code-area" class="w-full p-4 bg-slate-50 rounded-2xl font-mono text-xs break-all border-2 border-slate-200 h-28 focus:border-brand-500 outline-none text-slate-600 resize-none" readonly></textarea>
                 </div>
                 <div class="flex gap-3">
                     <button onclick="window.doCopyCode()" class="flex-1 py-3 bg-brand-600 text-white rounded-xl font-black text-sm shadow-lg hover:bg-brand-700 transition-all uppercase tracking-wide">–ö–û–ü–ò–†–ê–ô</button>
                     <button onclick="document.getElementById('modal-share').classList.add('hidden')" class="py-3 px-6 bg-slate-100 text-slate-500 rounded-xl font-black text-sm hover:bg-slate-200 uppercase tracking-wide">–ó–ê–¢–í–û–†–ò</button>
                 </div>
             </div>
        </div>

    </div>

    <!-- === CSS Utilities === -->
    <style>
        .input-field { @apply w-full p-4 bg-white rounded-2xl border-2 border-slate-100 font-bold mb-4 outline-none focus:border-brand-500 transition-all text-center text-slate-800; }
        .input-dark { @apply w-full p-5 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:border-brand-500 font-bold transition-all text-center; }
        .btn-primary { @apply text-white font-black rounded-2xl shadow-xl transition-all active:scale-95 uppercase tracking-widest; }
        .editor-q-card { @apply bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-3 transition-all hover:shadow-md hover:border-brand-200; }
        .option-label { @apply flex-1 flex flex-col items-center justify-center gap-2 p-3 bg-white rounded-2xl border-2 border-slate-100 cursor-pointer text-[10px] font-black hover:bg-brand-50 transition-colors select-none text-slate-500 uppercase hover:border-brand-200; }
    </style>

    <!-- === SCRIPT === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const appId = 'videoquiz-ultimate-live';
        // Your config
        const firebaseConfig = { apiKey: "AIzaSyA0WhbnxygznaGCcdxLBHweZZThezUO314", authDomain: "videoquiz-ultimate.firebaseapp.com", projectId: "videoquiz-ultimate", storageBucket: "videoquiz-ultimate.firebasestorage.app", messagingSenderId: "793138692820", appId: "1:793138692820:web:8ee2418d28d47fca6bf141" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let user = null, myQuizzes = [], questions = [], currentQuiz = null, currentVideoId = "";
        let player = null, hostPlayer = null, solvePlayer = null;
        let sessionID = "", liveParticipants = [], editingQuizId = null, editingQuestionIdx = -1, liveActiveQIdx = -1, liveScore = 0;
        let authMode = 'login', sopEnabled = false, isDiscussion = false;
        let activeHistoryTab = 'solo';
        const FIXED_TEACHER_ID = "uNdGTBsgatZX4uOPTZqKG9qLJVZ2";

        // GLOBAL HELPERS - DEFINED BEFORE USAGE
        window.switchScreen = (n) => { document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden')); document.getElementById('screen-'+n).classList.remove('hidden'); if(n==='dashboard') window.loadTeacherData(); if(window.lucide) lucide.createIcons(); };
        window.switchTab = (t) => { 
            document.getElementById('panel-solo').classList.toggle('hidden', t!=='solo'); 
            document.getElementById('panel-class').classList.toggle('hidden', t!=='class');
            document.getElementById('tab-solo').className = t==='solo'?'flex-1 py-3 rounded-xl font-bold text-sm bg-brand-600 text-white shadow transition-all uppercase tracking-widest':'flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-50 transition-all uppercase tracking-widest';
            document.getElementById('tab-class').className = t==='class'?'flex-1 py-3 rounded-xl font-bold text-sm bg-emerald-600 text-white shadow transition-all uppercase tracking-widest':'flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 hover:bg-slate-50 transition-all uppercase tracking-widest';
        };
        window.showMessage = (t) => alert(t);

        // AUTH
        onAuthStateChanged(auth, u => {
            user = u;
            if(u && !window.location.search.includes('pin=')) { if(u.email || u.isAnonymous) window.switchScreen('dashboard'); }
            else if(!window.location.search.includes('pin=')) window.switchScreen('welcome');
            document.getElementById('auth-loader').classList.add('hidden');
        });

        window.handleAuthSubmit = async () => {
            const em = document.getElementById('auth-email').value, ps = document.getElementById('auth-password').value;
            if(!em || !ps) return alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –¥–∞–Ω–Ω–∏");
            try {
                if(authMode==='register') {
                    if(document.getElementById('auth-teacher-code').value !== 'vilidaf76') return alert("–ì—Ä–µ—à–µ–Ω –∫–æ–¥");
                    await createUserWithEmailAndPassword(auth, em, ps);
                } else await signInWithEmailAndPassword(auth, em, ps);
            } catch(e) { 
                if(e.code==='auth/operation-not-allowed') { await signInAnonymously(auth); window.switchScreen('dashboard'); } 
                else alert(e.message); 
            }
        };
        window.toggleAuthMode = () => { authMode = authMode==='login'?'register':'login'; document.getElementById('reg-extra').classList.toggle('hidden'); document.getElementById('auth-btn').innerText = authMode==='login'?'–í–õ–ï–ó':'–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø'; };
        window.handleLogout = () => signOut(auth);

        // TEACHER
        window.loadTeacherData = () => {
            if(!user) return;
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'my_quizzes'), s => {
                myQuizzes = s.docs.map(d => ({...d.data(), id: d.id}));
                window.renderMyQuizzes();
            });
            window.switchHistoryTab('solo'); // Load initial stats
        };

        window.renderMyQuizzes = () => {
            const list = document.getElementById('my-quizzes-list');
            list.innerHTML = myQuizzes.map(q => {
                const code = btoa(unescape(encodeURIComponent(JSON.stringify({v:q.v, q:q.questions, title:q.title, owner: user.isAnonymous ? FIXED_TEACHER_ID : user.uid}))));
                return `
                <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm flex flex-col hover:shadow-xl transition-all">
                    <h4 class="font-black text-lg mb-2 line-clamp-1 text-slate-800">${q.title}</h4>
                    <span class="text-[10px] font-black text-slate-400 mb-6 uppercase tracking-widest border border-slate-100 rounded-full px-3 py-1 w-fit">${q.questions?.length||0} –≤—ä–ø—Ä–æ—Å–∞</span>
                    <div class="flex gap-2 mt-auto pt-4 border-t border-slate-100">
                        <button onclick="window.startLiveSessionHost('${q.id}')" class="flex-1 py-3 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-black text-[10px] uppercase shadow-lg transition-all active:scale-95">–°–¢–ê–†–¢</button>
                        <button onclick="window.showShareModal('${code}')" class="p-3 bg-amber-50 text-amber-600 hover:bg-amber-100 rounded-xl transition-colors"><i data-lucide="link" class="w-4 h-4"></i></button>
                        <button onclick="window.initEditMode('${q.id}')" class="p-3 bg-slate-50 text-slate-500 hover:bg-slate-100 rounded-xl transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="window.deleteQuiz('${q.id}')" class="p-3 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        };

        window.showShareModal = (code) => {
            document.getElementById('share-code-area').value = code;
            document.getElementById('modal-share').classList.remove('hidden');
            document.getElementById('modal-share').classList.add('flex');
        };
        window.doCopyCode = () => { document.getElementById('share-code-area').select(); document.execCommand('copy'); alert("–ö–æ–¥—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω!"); };
        window.deleteQuiz = async (id) => { if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.isAnonymous ? FIXED_TEACHER_ID : user.uid, 'my_quizzes', id)); };

        // EDITOR
        window.initCreateMode = () => { editingQuizId = null; questions = []; currentVideoId = ""; document.getElementById('editor-yt-url').value=""; window.switchScreen('editor'); window.renderEditorQuestions(); };
        window.initEditMode = (id) => { 
            const q = myQuizzes.find(x=>x.id===id); editingQuizId=id; questions=[...q.questions]; currentVideoId=q.v; 
            document.getElementById('editor-yt-url').value = `https://youtu.be/${q.v}`;
            window.switchScreen('editor'); window.renderEditorQuestions(); window.loadEditorVideo();
        };

        window.loadEditorVideo = () => {
            const url = document.getElementById('editor-yt-url').value;
            const id = url.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/watch\?.+&v=))([\w-]{11})/)?.[1];
            if(!id) return alert("–ù–µ–≤–∞–ª–∏–¥–µ–Ω –ª–∏–Ω–∫");
            currentVideoId = id;
            document.getElementById('editor-video-container').innerHTML = '<div id="e-player"></div>';
            player = new YT.Player('e-player', { videoId: id, playerVars: { controls: 1 } });
            setInterval(() => { if(player && player.getCurrentTime) {
                const t = Math.floor(player.getCurrentTime());
                document.getElementById('editor-timer').innerText = `${Math.floor(t/60)}:${t%60<10?'0':''}${t%60}`;
            }}, 500);
        };

        window.adjustQuestionTime = (idx, delta) => {
            if(questions[idx]) {
                questions[idx].time = Math.max(0, questions[idx].time + delta);
                window.renderEditorQuestions();
            }
        };

        window.renderEditorQuestions = () => {
            const list = document.getElementById('editor-q-list');
            list.innerHTML = questions.sort((a,b)=>a.time-b.time).map((q, i) => `
            <div class="editor-q-card flex flex-col gap-2 group">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1 border border-slate-200">
                        <button onclick="window.adjustQuestionTime(${i}, -1)" class="w-7 h-7 flex items-center justify-center font-bold hover:bg-white rounded shadow-sm text-slate-500 transition-all">-</button>
                        <span class="font-mono text-xs font-black min-w-[40px] text-center text-slate-700">${Math.floor(q.time/60)}:${q.time%60<10?'0':''}${q.time%60}</span>
                        <button onclick="window.adjustQuestionTime(${i}, 1)" class="w-7 h-7 flex items-center justify-center font-bold hover:bg-white rounded shadow-sm text-slate-500 transition-all">+</button>
                    </div>
                    <div class="flex gap-1 opacity-100 group-hover:opacity-100 transition-opacity">
                        <button onclick="window.openQuestionModal(${i})" class="text-brand-600 p-2 hover:bg-brand-50 rounded-lg transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="questions.splice(${i},1);window.renderEditorQuestions()" class="text-rose-500 p-2 hover:bg-rose-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <p class="text-sm font-bold text-slate-800 line-clamp-2 pl-1">${q.text}</p>
                <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest pl-1">${q.type === 'timeline' ? '–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è' : q.type}</div>
            </div>`).join('');
            lucide.createIcons();
        };

        window.openQuestionModal = (idx = -1) => {
            editingQuestionIdx = idx;
            const t = player ? Math.floor(player.getCurrentTime()) : 0;
            const q = idx!==-1 ? questions[idx] : { text: "", type: "single", time: t, points: 1 };
            
            document.getElementById('m-q-text').value = q.text;
            document.getElementById('m-q-type').value = q.type;
            window.updateModalFields();
            document.getElementById('modal-q').classList.remove('hidden');
            document.getElementById('modal-q').classList.add('flex');
        };
        window.closeQuestionModal = () => document.getElementById('modal-q').classList.add('hidden');

        window.updateModalFields = () => {
            const t = document.getElementById('m-q-type').value, area = document.getElementById('m-q-opts-area');
            const q = editingQuestionIdx!==-1 ? questions[editingQuestionIdx] : null;
            area.innerHTML = '';
            
            if(['single','multiple','ordering'].includes(t)) {
                for(let i=0;i<4;i++) area.innerHTML += `<div class="flex gap-2 mb-2"><input type="${t==='single'?'radio':'checkbox'}" name="q-ans" value="${i}" ${q&&((t==='single'&&q.correct===i)||(t!=='single'&&q.correct?.includes(i)))?'checked':''} class="accent-brand-600 w-5 h-5"><input type="text" class="q-opt w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-bold focus:border-brand-500 outline-none" placeholder="–û—Ç–≥–æ–≤–æ—Ä" value="${q?.options[i]||''}"></div>`;
            } else if(t==='boolean') {
                area.innerHTML = `<div class="flex gap-4"><label class="p-4 border-2 border-emerald-100 bg-emerald-50 rounded-xl w-full text-center cursor-pointer font-black text-emerald-700 text-xs uppercase tracking-widest hover:bg-emerald-100 transition-colors"><input type="radio" name="b-val" value="true" checked class="hidden"> –í–Ø–†–ù–û</label><label class="p-4 border-2 border-rose-100 bg-rose-50 rounded-xl w-full text-center cursor-pointer font-black text-rose-700 text-xs uppercase tracking-widest hover:bg-rose-100 transition-colors"><input type="radio" name="b-val" value="false" class="hidden"> –ì–†–ï–®–ù–û</label></div>`;
            } else if(t==='timeline') {
                area.innerHTML = `
                <div class="grid grid-cols-3 gap-3 text-[10px] font-black uppercase text-slate-400 mb-3 tracking-widest">
                    <div>–ù–∞—á–∞–ª–æ<input type="number" id="tl_min" class="p-3 border-2 border-slate-200 rounded-xl w-full text-slate-800 text-base mt-1 outline-none focus:border-brand-500" value="${q?.min||1800}"></div>
                    <div>–ö—Ä–∞–π<input type="number" id="tl_max" class="p-3 border-2 border-slate-200 rounded-xl w-full text-slate-800 text-base mt-1 outline-none focus:border-brand-500" value="${q?.max||2000}"></div>
                    <div>–°—Ç—ä–ø–∫–∞<input type="number" id="tl_step" class="p-3 border-2 border-slate-200 rounded-xl w-full text-slate-800 text-base mt-1 outline-none focus:border-brand-500" value="${q?.step||10}"></div>
                </div>
                <div class="p-4 bg-brand-50 rounded-2xl border-2 border-brand-100 text-center"><p class="text-[10px] font-black uppercase text-brand-400 mb-1 tracking-widest">–í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä</p><input type="number" id="num_ans" class="w-full p-2 bg-transparent text-center font-black text-3xl text-brand-700 outline-none" value="${q?.correct||1900}"></div>`;
            } else {
                 area.innerHTML = `<input type="number" id="num_ans" class="w-full p-4 border-2 border-slate-200 rounded-xl text-center font-black text-3xl outline-none focus:border-brand-500" value="${q?.correct||50}">`;
            }
        };

        window.saveCurrentQuestion = () => {
            const text = document.getElementById('m-q-text').value; if(!text) return alert("–í—ä–≤–µ–¥–µ—Ç–µ –≤—ä–ø—Ä–æ—Å");
            const type = document.getElementById('m-q-type').value;
            let q = { text, type, time: editingQuestionIdx!==-1 ? questions[editingQuestionIdx].time : (player ? Math.floor(player.getCurrentTime()) : 0), points: 1 };
            
            if(['single','multiple','ordering'].includes(type)) {
                q.options = Array.from(document.querySelectorAll('.q-opt')).map(i=>i.value);
                if(type==='single') q.correct = parseInt(document.querySelector('input[name="q-ans"]:checked')?.value||0);
                else q.correct = Array.from(document.querySelectorAll('input[name="q-ans"]:checked')).map(i=>parseInt(i.value));
            } else if(type==='boolean') q.correct = document.querySelector('input[name="b-val"]:checked').value === 'true', q.options=["–í—è—Ä–Ω–æ","–ì—Ä–µ—à–Ω–æ"];
            else if(type==='timeline') {
                q.correct = parseInt(document.getElementById('num_ans').value);
                q.min = parseInt(document.getElementById('tl_min').value); q.max = parseInt(document.getElementById('tl_max').value); q.step = parseInt(document.getElementById('tl_step').value);
            } else q.correct = parseInt(document.getElementById('num_ans').value);

            if(editingQuestionIdx!==-1) questions[editingQuestionIdx] = q; else questions.push(q);
            window.renderEditorQuestions(); window.closeQuestionModal();
        };

        window.finalizeAndSaveQuiz = async () => {
            if(!currentVideoId || !questions.length) return alert("–ù–µ–ø—ä–ª–µ–Ω —É—Ä–æ–∫");
            const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
            let title = prompt("–ò–º–µ –Ω–∞ —É—Ä–æ–∫–∞:", editingQuizId ? myQuizzes.find(x=>x.id===editingQuizId).title : ""); if(!title) return;
            const data = { title, v: currentVideoId, questions, owner: uid, updatedAt: serverTimestamp() };
            if(editingQuizId) await updateDoc(doc(db,'artifacts',appId,'users',uid,'my_quizzes',editingQuizId), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db,'artifacts',appId,'users',uid,'my_quizzes'), data); }
            window.switchScreen('dashboard');
        };

        // --- STATS ---
        window.switchHistoryTab = (t) => {
            activeHistoryTab = t;
            document.getElementById('h-tab-solo').className = t === 'solo' ? "px-4 py-1.5 rounded-lg font-bold text-xs bg-brand-600 text-white shadow-md transition-all uppercase tracking-widest" : "px-4 py-1.5 rounded-lg font-bold text-xs text-slate-500 hover:text-slate-800 transition-all uppercase tracking-widest";
            document.getElementById('h-tab-class').className = t === 'class' ? "px-4 py-1.5 rounded-lg font-bold text-xs bg-emerald-600 text-white shadow-md transition-all uppercase tracking-widest" : "px-4 py-1.5 rounded-lg font-bold text-xs text-slate-500 hover:text-slate-800 transition-all uppercase tracking-widest";
            window.loadStats();
        };

        window.loadStats = () => {
             const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
             const ref = activeHistoryTab === 'solo' ? collection(db, 'artifacts', appId, 'public', 'data', 'solo_results') : collection(db, 'artifacts', appId, 'users', uid, 'class_history');
             
             onSnapshot(ref, s => {
                 let data = s.docs.map(d=>({...d.data(), id: d.id}));
                 if(activeHistoryTab === 'solo') data = data.filter(r => r.teacherId === uid);
                 window.renderStatsTable(data);
             });
        };

        window.renderStatsTable = (data) => {
            const body = document.getElementById('history-body');
            body.innerHTML = data.map(r => `
            <tr class="border-b border-slate-50 text-xs">
                <td class="p-4 font-black text-slate-700">${activeHistoryTab==='solo'?r.studentName: (r.timestamp?.toDate().toLocaleDateString('bg-BG') || '...')}</td>
                <td class="p-4 text-slate-500 font-bold">${r.quizTitle}</td>
                <td class="p-4 text-right font-black text-brand-600">${r.score || (r.participants ? r.participants.length : 0)}</td>
                <td class="p-4 text-center">
                    <button onclick="window.deleteStat('${r.id}')" class="text-rose-400 p-2 hover:bg-rose-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td>
            </tr>`).join('');
            lucide.createIcons();
        };
        
        window.deleteStat = async (id) => {
             if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) {
                 const uid = user.isAnonymous ? FIXED_TEACHER_ID : user.uid;
                 if(activeHistoryTab==='solo') await deleteDoc(doc(db,'artifacts',appId,'public','data','solo_results',id));
                 else await deleteDoc(doc(db,'artifacts',appId,'users',uid,'class_history',id));
             }
        };

        // --- CLIENT / SOLO LOGIC ---
        window.renderOptionsUI = (q, area, mode) => {
            // FIXED: Buttons for boolean are now visible on mobile
            if(q.type === 'boolean') {
                area.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 h-auto sm:h-32">
                    <button onclick="window.selectOpt(this, true, 'boolean', '${mode}')" class="bg-emerald-500 text-white rounded-2xl font-black text-xl py-6 sm:py-0 hover:bg-emerald-400 shadow-md transition-transform active:scale-95 uppercase tracking-widest border-b-4 border-emerald-700 active:border-b-0 active:translate-y-1">–í–Ø–†–ù–û</button>
                    <button onclick="window.selectOpt(this, false, 'boolean', '${mode}')" class="bg-rose-500 text-white rounded-2xl font-black text-xl py-6 sm:py-0 hover:bg-rose-400 shadow-md transition-transform active:scale-95 uppercase tracking-widest border-b-4 border-rose-700 active:border-b-0 active:translate-y-1">–ì–†–ï–®–ù–û</button>
                </div>`;
                return;
            }
            if(q.type === 'timeline') {
                const isSolo = mode === 'solo';
                area.innerHTML = `
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border-2 border-slate-100 text-center w-full relative range-container mt-12 mb-8">
                    <div class="range-bubble" id="bubble_${mode}">${q.min}</div>
                    <input type="range" min="${q.min}" max="${q.max}" step="${q.step}" value="${q.min}" class="timeline-slider w-full" oninput="
                        document.getElementById('bubble_${mode}').innerText=this.value; 
                        document.getElementById('bubble_${mode}').style.left = ((this.value - this.min)*100)/(this.max-this.min) + '%';
                        window.tempSelected=parseInt(this.value); 
                        document.getElementById('${isSolo?'ind':'client'}-confirm-btn').classList.remove('hidden');
                        if('${mode}'==='client') document.getElementById('client-confirm-bar').classList.remove('hidden');
                    ">
                    <div class="flex justify-between text-xs font-black text-slate-400 mt-4 uppercase tracking-widest"><span>${q.min}</span><span>${q.max}</span></div>
                </div>`;
                return;
            }
            if(['single', 'multiple'].includes(q.type)) {
                q.options.forEach((o, i) => {
                    area.innerHTML += `<button onclick="window.selectOpt(this, ${i}, '${q.type}', '${mode}')" class="w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-lg text-slate-700 shadow-sm mb-3 uppercase hover:border-brand-500 hover:text-brand-600 transition-all ${sopEnabled?'sop-text':''}" style="text-align: left;">${o}</button>`;
                });
            }
        };

        window.selectOpt = (el, val, type, mode) => {
             const btnId = mode === 'solo' ? 'ind-confirm-btn' : 'client-confirm-btn';
             if(type === 'boolean' || type === 'single') {
                 if(el.parentElement) Array.from(el.parentElement.children).forEach(c => {
                    c.classList.remove('ring-4', 'ring-brand-200', 'scale-105', 'border-brand-500', 'text-brand-600');
                    if(c.tagName === 'BUTTON' && type === 'single') c.classList.add('border-slate-100', 'text-slate-700');
                 });
                 if(type === 'single') {
                    el.classList.remove('border-slate-100', 'text-slate-700');
                    el.classList.add('border-brand-500', 'text-brand-600', 'ring-4', 'ring-brand-200');
                 } else {
                    el.classList.add('scale-105', 'ring-4', 'ring-white/50');
                 }
             }
             window.tempSelected = val;
             document.getElementById(btnId).classList.remove('hidden');
             // For client on mobile, show bottom bar
             if(mode === 'client') document.getElementById('client-confirm-bar').classList.remove('hidden');
        };

        // --- HOST ---
        window.startLiveSessionHost = async (id) => {
            const q = myQuizzes.find(x=>x.id===id); currentQuiz=q;
            sessionID = Math.floor(1000 + Math.random() * 9000).toString();
            window.switchScreen('live-host');
            document.getElementById('host-pin-display').innerText = sessionID;
            // Smaller QR
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?pin=' + sessionID)}`;
            document.getElementById('host-qr-container').innerHTML = `<img src="${qrUrl}" class="w-24 h-24 rounded-lg mx-auto">`;
            
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID), {
                status: 'waiting', pin: sessionID, quizTitle: q.title, activeQ: -1, timestamp: serverTimestamp(), totalQs: q.questions.length
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID, 'participants'), s => {
                liveParticipants = s.docs.map(d=>d.data());
                document.getElementById('host-count').innerText = liveParticipants.length;
                document.getElementById('host-leaderboard').innerHTML = liveParticipants.sort((a,b)=>b.score-a.score).map((p,i)=>`<div class="flex justify-between p-3 text-white border-b border-white/10 text-xs items-center"><span class="font-black text-brand-300">#${i+1}</span> <span class="font-bold">${p.name}</span><span class="font-black bg-white/10 px-2 py-1 rounded">${p.score}</span></div>`).join('');
            });
        };
        
        window.startLiveVideo = () => {
             document.getElementById('host-start-overlay').classList.add('hidden');
             document.getElementById('host-player-container').innerHTML = '<div id="h-player"></div>';
             hostPlayer = new YT.Player('h-player', { videoId: currentQuiz.v, playerVars: { autoplay: 1, controls: 0 }, events: { 'onStateChange': e => {
                 if(e.data===1) {
                     const i = setInterval(() => {
                         const t = Math.floor(hostPlayer.getCurrentTime());
                         const qIdx = currentQuiz.questions.findIndex(q => Math.abs(q.time - t) <= 1);
                         if(qIdx !== -1 && qIdx !== liveActiveQIdx) {
                             liveActiveQIdx = qIdx; hostPlayer.pauseVideo();
                             document.getElementById('host-resume-overlay').classList.remove('hidden');
                             updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID), { status: 'active', activeQ: qIdx, qData: currentQuiz.questions[qIdx] });
                         }
                     }, 1000);
                 }
             }}});
        };
        window.resumeLiveVideo = () => {
            document.getElementById('host-resume-overlay').classList.add('hidden');
            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID), { status: 'playing' });
            hostPlayer.playVideo();
        };

        // --- CLIENT ---
        window.joinLiveSession = async () => {
             const pin = document.getElementById('live-pin').value; const name = document.getElementById('live-student-name').value;
             if(!pin || !name) return alert("–î–∞–Ω–Ω–∏?");
             if(!auth.currentUser) await signInAnonymously(auth);
             const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin));
             if(!snap.exists()) return alert("–ì—Ä–µ—à–µ–Ω –∫–æ–¥");
             sessionID = pin; window.switchScreen('live-client');
             document.getElementById('client-name-badge').innerText = name;
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin, 'participants', auth.currentUser.uid), { name, score: 0, uid: auth.currentUser.uid, ansCount: 0 });
             
             onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sessions', pin), s => {
                 const d = s.data();
                 if(d.status === 'active' && d.activeQ !== liveActiveQIdx) {
                     liveActiveQIdx = d.activeQ; currentQuiz = {q: [d.qData]}; 
                     window.renderOptionsUI(d.qData, document.getElementById('client-options'), 'client');
                     document.getElementById('client-waiting').classList.add('hidden');
                     document.getElementById('client-question').classList.remove('hidden');
                     document.getElementById('client-q-text').innerText = d.qData.text;
                     document.getElementById('client-confirm-bar').classList.add('hidden');
                 } else if(d.status === 'playing') {
                     document.getElementById('client-question').classList.add('hidden');
                     document.getElementById('client-waiting').classList.remove('hidden');
                 } else if(d.status === 'finished') {
                      document.getElementById('client-question').classList.add('hidden');
                      document.getElementById('client-finished').classList.remove('hidden');
                 }
             });
        };
        
        window.submitLiveAnswer = async () => {
             // Score calculation simplified
             const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'sessions', sessionID, 'participants', auth.currentUser.uid);
             await updateDoc(pRef, { ansCount: liveActiveQIdx + 1 });
             document.getElementById('client-question').classList.add('hidden');
             document.getElementById('client-waiting').classList.remove('hidden');
        };

        window.onYouTubeIframeAPIReady = () => console.log("YT Ready");
        window.addEventListener('DOMContentLoaded', () => { 
            const p = new URLSearchParams(window.location.search).get('pin'); 
            if(p) { window.switchTab('class'); document.getElementById('live-pin').value = p; } 
        });

    </script>
</body>
</html>
